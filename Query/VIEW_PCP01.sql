CREATE VIEW TSTPCPR2(
	C2_FILIAL,
	C2_NUM,
	C2_PRODUTO,
	B1_DESCOP,
	C2_QUANT,
	C2_UM,
	C2_EMISSAO,
	C2_DATRF,
	C2_QUJE,
	CondBaixa,
	CondOperac,
	D3_COD,
	B1_DESCCON,
	D3_QUANT,
	D3_UM,
	D3_OP,
	D3_EMISSAO,
	D3_CUSTO1,
	D3_LOTECTL,
	D3_USUARIO
) AS
SELECT
	SC2.C2_FILIAL,
	SC2.C2_NUM,
	SC2.C2_PRODUTO,
	SB1.B1_DESC,
	SC2.C2_QUANT,
	SC2.C2_UM,
	SC2.C2_EMISSAO,
	SC2.C2_DATRF,
	SC2.C2_QUJE,
	CASE
		WHEN DT.H6_OP IS NULL THEN 'Não baixada'
		ELSE 'OK'
	END AS CondBaixa,
	CASE 
		WHEN DT2.H6_OPERAC IS NULL THEN NULL
		WHEN DT2.C2_OPERAC <> DT2.H6_OPERAC THEN 'Operações Divergentes'
		ELSE 'OK'
	END AS CondOperac,
	DT4.D3_COD,
	DT4.B1_DESC,
	DT4.D3_QUANT,
	DT4.D3_UM,
	DT4.D3_OP,
	DT4.D3_EMISSAO,
	DT4.D3_CUSTO1,
	DT4.D3_LOTECTL,
	DT4.D3_USUARIO
	--CASE 
	--	WHEN COUNT(DT3.D3_COD) = 0 AND COUNT(DT4.D3_COD) = 0 THEN 'OK'
	--	ELSE CAST(COUNT(DT3.D3_COD) AS VARCHAR(2))
	--END AS 'Dif. Estrutura x Consumo'
FROM 
	SC2100 SC2
	LEFT JOIN SB1100 SB1 ON SB1.B1_COD = C2_PRODUTO
	LEFT JOIN (SELECT * FROM SH6100 WHERE D_E_L_E_T_ = '' 
	AND H6_OP IN (SELECT C2_NUM + '01001' FROM SC2100)) 
	AS DT ON DT.H6_OP = SC2.C2_NUM + '01001'
	LEFT JOIN (
	SELECT -- OPs de Operação Congruente
		SD4.D4_OP, 
		SD4.D4_OPERAC,
		SC2.C2_OPERAC,
		SH6.H6_OPERAC
	FROM 
		SD4100 SD4
		INNER JOIN SC2100 SC2 ON SC2.C2_NUM + '01001' = SD4.D4_OP
		LEFT JOIN (SELECT * FROM SH6100 WHERE D_E_L_E_T_ = '' 
		AND H6_OP IN (SELECT C2_NUM + '01001' FROM SC2100)) 
		AS SH6 ON SH6.H6_OP = SC2.C2_NUM + '01001'
	WHERE 
		SD4.D_E_L_E_T_ = ''
		AND SC2.D_E_L_E_T_ = ''
		AND SD4.D4_OPERAC <> ''
	GROUP BY 
		SD4.D4_OP, 
		SD4.D4_OPERAC,
		SC2.C2_OPERAC,
		SH6.H6_OPERAC
	) AS DT2 ON DT2.D4_OP = SC2.C2_NUM + '01001'
	LEFT JOIN (
		SELECT -- Diferença Estrutura X Consumo
			D3_COD,
			D3_OP
		FROM 
			SD3100 SD3
		WHERE 
			SD3.D_E_L_E_T_ = ''
			AND D3_OP <> ''
			AND D3_OP NOT LIKE '%OS%'
			AND D3_ESTORNO = ''
			AND D3_TM = '999'
			AND D3_COD NOT IN (SELECT G1_COMP FROM SG1100 WHERE D_E_L_E_T_ = '')
		GROUP BY
			D3_COD,
			D3_OP
	) AS DT3 ON DT3.D3_OP = SC2.C2_NUM + '01001'
	LEFT JOIN (
		SELECT 
			D3_COD,
			B1_DESC,
			D3_QUANT,
			D3_UM,
			D3_OP,
			D3_EMISSAO,
			D3_CUSTO1,
			D3_LOTECTL,
			D3_USUARIO
		FROM 
			SD3100 SD3
			LEFT JOIN SB1100 ON D3_COD = B1_COD
		WHERE 
			SD3.D_E_L_E_T_ = ''
			AND SB1100.D_E_L_E_T_ = ''
			AND D3_OP <> ''
			AND D3_OP NOT LIKE '%OS%'
			AND D3_ESTORNO = ''
			AND D3_TM = '999'
			AND D3_COD IN (SELECT G1_COMP FROM SG1100 WHERE D_E_L_E_T_ = '')
		GROUP BY
			D3_COD,
			B1_DESC,
			D3_QUANT,
			D3_UM,
			D3_OP,
			D3_EMISSAO,
			D3_CUSTO1,
			D3_LOTECTL,
			D3_USUARIO
	) AS DT4 ON DT4.D3_OP = SC2.C2_NUM + '01001'
WHERE
	SC2.D_E_L_E_T_ = ''
	AND SB1.D_E_L_E_T_ = ''
	AND SC2.C2_ITEM <> 'OS'
GROUP BY 
	SC2.C2_FILIAL,
	SC2.C2_NUM,
	SC2.C2_PRODUTO,
	SB1.B1_DESC,
	SC2.C2_QUANT,
	SC2.C2_UM,
	SC2.C2_EMISSAO,
	SC2.C2_DATRF,
	SC2.C2_QUJE,
	CASE
		WHEN DT.H6_OP IS NULL THEN 'Não baixada'
		ELSE 'OK'
	END,
	CASE 
		WHEN DT2.H6_OPERAC IS NULL THEN NULL
		WHEN DT2.C2_OPERAC <> DT2.H6_OPERAC THEN 'Operações Divergentes'
		ELSE 'OK'
	END,
	DT4.D3_COD,
	DT4.B1_DESC,
	DT4.D3_QUANT,
	DT4.D3_UM,
	DT4.D3_OP,
	DT4.D3_EMISSAO,
	DT4.D3_CUSTO1,
	DT4.D3_LOTECTL,
	DT4.D3_USUARIO;