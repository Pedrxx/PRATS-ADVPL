// fImpFun
// Imp_Cabec

#INCLUDE "rwmake.ch"        
#define STR0001 If( cPaisLoc $ "ANG|PTG", "Espelho Do Ponto", "Espelho do Ponto" )
#define STR0002 If( cPaisLoc $ "ANG|PTG", "Sera impresso de acordo com os parametro s solicitados pelo", "Sera impresso de acordo com os parametros solicitados pelo" )
#define STR0003 If( cPaisLoc $ "ANG|PTG", "Utilizador.", "usuario." )
#define STR0004 If( cPaisLoc $ "ANG|PTG", "Matr�cula", "Matricula" )
#define STR0005 If( cPaisLoc $ "ANG|PTG", "Centro De Custo", "Centro de Custo" )
#define STR0006 "Nome"
#define STR0007 "Turno"
#define STR0008 If( cPaisLoc $ "ANG|PTG", "C�digo de barras", "Zebrado" )
#define STR0009 If( cPaisLoc $ "ANG|PTG", "Administra��o", "Administracao" )
#define STR0013 "Assinatura do Empregado"
#define STR0014 "T O T A I S"
#define STR0015 If( cPaisLoc $ "ANG|PTG", "C�d descri��o                c�lc.            c�d descri��o                c�lc.          ", "Cod Descricao                Calc.            Cod Descricao                Calc.          " )
#define STR0016 If( cPaisLoc $ "ANG|PTG", "C�d Descri��o                         Infor.  C�d Descri��o                         Infor.", "Cod Descricao                         Infor.  Cod Descricao                         Infor." )
#define STR0017 If( cPaisLoc $ "ANG|PTG", "C�d Descri��o                C�lc.    Infor.  C�d Descri��o                C�lc.    Infor.", "Cod Descricao                Calc.    Infor.  Cod Descricao                Calc.    Infor." )
#define STR0018 If( cPaisLoc $ "ANG|PTG", "** excep��o n�o trabalhada **", "** Excecao nao Trabalhada **" )
#define STR0019 If( cPaisLoc $ "ANG|PTG", "** feriado **", "** Feriado **" )
#define STR0020 If( cPaisLoc $ "ANG|PTG", "** ausente **", "** Ausente **" )
#define STR0021 If( cPaisLoc $ "ANG|PTG", "** d.s.r. **", "** D.S.R. **" )
#define STR0022 If( cPaisLoc $ "ANG|PTG", "** Compensado", "** Compensado **" )
#define STR0023 "** Nao Trabalhado **"
#define STR0024 If( cPaisLoc $ "ANG|PTG", "Emp.:", "Emp...: " )
#define STR0025 If( cPaisLoc $ "ANG|PTG", "Reg.:", " Matr..: " )
#define STR0026 If( cPaisLoc $ "ANG|PTG", "  CArt�o: ", "  Chapa : " )
#define STR0027 If( cPaisLoc $ "ANG|PTG", "E.n.d.:", "End...: " )
#define STR0028 " Nome..: "
#define STR0029 If( cPaisLoc $ "ANG|PTG", "N.� contribuinte", "CGC...: " )
#define STR0030 If( cPaisLoc $ "ANG|PTG", " fun��o: ", " Funcao: " )
#define STR0031 If( cPaisLoc $ "ANG|PTG", "C.c.:", "C.C...: " )
#define STR0032 " Categ.: "
#define STR0033 If( cPaisLoc $ "ANG|PTG", "Turno:", "Turno.: " )
#define STR0034 If( cPaisLoc $ "ANG|PTG", "DAta     Dia     ", "   DATA    DIA     " )
#define STR0035 If( cPaisLoc $ "ANG|PTG", "A.e.", "a E. " )
#define STR0036 If( cPaisLoc $ "ANG|PTG", "A s. ", "a S. " )
#define STR0037 If( cPaisLoc $ "ANG|PTG", "Observa��o  Horas  Tipo Da Marca��o", "Observacao                Horas  Tipo da Marcacao" )
#define STR0038 If( cPaisLoc $ "ANG|PTG", "C.custo + Nome", "C.Custo + Nome" )
#define STR0039 If( cPaisLoc $ "ANG|PTG", "Per�odo De Apontamento Inv�lido.", "Periodo de Apontamento Invalido." )
#define STR0040 If( cPaisLoc $ "ANG|PTG", "Consultar Marca��es", "Consultar Marcacoes" )
#define STR0041 If( cPaisLoc $ "ANG|PTG", "Motivo De Autoriza��o", "Motivo de Abono" )
#define STR0042 "Data"
#define STR0043 "Dia"
#define STR0044 If( cPaisLoc $ "ANG|PTG", "&#170;e.", "&#170;E." )
#define STR0045 If( cPaisLoc $ "ANG|PTG", "&#170;s.", "&#170;S." )
#define STR0046 If( cPaisLoc $ "ANG|PTG", "Observa&��e&s", "Observacoes" )
#define STR0047 If( cPaisLoc $ "ANG|PTG", "Horas   Tipo Da Marca&��&o", "Horas  Tipo da Marcacao" )
#define STR0048 If( cPaisLoc $ "ANG|PTG", "Turno", "Turno " )
#define STR0049 If( cPaisLoc $ "ANG|PTG", "Turnos:", "Turnos: " )
#define STR0050 If( cPaisLoc $ "ANG|PTG", "Processo + registo", "Processo + Matricula" )
#define STR0051 "Depto.: "
#define STR0052 If( cPaisLoc $ "ANG|PTG", "Seleccionar a op��o  de impressao: ", "Selecione a opcao de impressao: " )
#define STR0053 If( cPaisLoc $ "ANG|PTG", "Por per�odo", "Por Periodo" )
#define STR0054 "Por Datas"
#define STR0055 "Processo: "
#define STR0056 If( cPaisLoc $ "ANG|PTG", "Per�odo", "Periodo" )
#define STR0057 If( cPaisLoc $ "ANG|PTG", "Mapa: ", "Roteiro: " )
#define STR0058 If( cPaisLoc $ "ANG|PTG", "Num. pgt: ", "Num. Pagto: " )
#define STR0059 "Informado                 Horas"
#define STR0060 "Departamento"
#define STR0061 "Departamento + Nome"
#define STR0062 "Abono"
#define STR0063 "Observacao"
#define STR0064 "Cod"
#define STR0065 "Descricao"
#define STR0066 "Calc."
#define STR0067 "Infor."
#define STR0068 "H.E."
#define STR0069 "Absent."
#define STR0070 "Ad. Not."
#define STR0071 "Empresa: "
#define STR0072 "Matricula: "
#define STR0073 "Chapa: "
#define STR0074 "Nome: "
#define STR0075 "CNPJ: "
#define STR0076 "Funcao: "
#define STR0077 "C.C.: "
#define STR0078 "Categoria: "
#define STR0079 "Turno: "
#define STR0080 "Para esse relatario o parametro MV_COLMARC deve ser menor ou igual � 5."
#define STR0081 "Banco de Horas"
#define STR0082 "Saldo Anterior"
#define STR0083 "Debito"
#define STR0084 "Credito"
#define STR0085 "Saldo Atual"
#INCLUDE "PROTHEUS.CH"
#INCLUDE "RPTDEF.CH"  
#INCLUDE "FWPrintSetup.ch"

#IFNDEF DEFAULT
	#xcommand DEFAULT	<uVar1> := <uVal1> ;
						[, <uVarN> := <uValN> ] => ;
    					<uVar1> := If( <uVar1> == nil, <uVal1>, <uVar1> ) ;;
   						[ <uVarN> := If( <uVarN> == nil, <uValN>, <uVarN> ); ]
#ENDIF

/*
���������������������������������������������������������������������������������������
���������������������������������������������������������������������������������������
�����������������������������������������������������������������������������������Ŀ��
���Fun��o    � Vers�o 1 � Autor � Equipe Advanded RH              � Data � 07.04.96 ���
���          � Vers�o 2 � Autor � Leandro Drumond                 � Data � 17.03.15 ���
�����������������������������������������������������������������������������������Ĵ��
���Descri��o � Espelho do Ponto                                                     ���
�����������������������������������������������������������������������������������Ĵ��
���Sintaxe   � PONR010(void)                                                        ���
�����������������������������������������������������������������������������������Ĵ��
���Parametros�                                                                      ���
�����������������������������������������������������������������������������������Ĵ��
��� Uso      � Generico                                                             ���
�����������������������������������������������������������������������������������Ĵ��
���         ATUALIZACOES SOFRIDAS DESDE A CONSTRU�AO INICIAL.                       ���
�����������������������������������������������������������������������������������Ĵ��
���Programador �    Data   �     FNC     �  Motivo da Alteracao                     ���
�����������������������������������������������������������������������������������Ĵ��
���Leandro Dr. �17/03/2015 �      		 �Convers�o para FWMSPRINTER.               ���
������������������������������������������������������������������������������������ٱ�
���������������������������������������������������������������������������������������
���������������������������������������������������������������������������������������*/
User Function PRTPONR1( lTerminal , cFilTerminal , cMatTerminal , cPerAponta, lPortal, aRetPortal )

Local aArea		 := GetArea()
Local aOrdem     := {STR0004 , STR0005 , STR0006 , STR0007, STR0038, STR0060, STR0061  } // 'Matricula'###'Centro de Custo'###'Nome'###'Turno'###'C.Custo + Nome'###'Departamento'###'Departamento + Nome'
Local cHtml		 := ""
Local cAviso	
Local aFilesOpen := {"SP5", "SPN", "SP8", "SPG","SPB","SPL","SPC", "SPH", "SPF"}
Local bCloseFiles:= {|cFiles| If( Select(cFiles) > 0, (cFiles)->( DbCloseArea() ), NIL) }
Local oPrinter
Local oSetup
Local cSession	 := GetPrinterSession()
Local cDevice    := fwGetProfString(cSession,"PRINTTYPE","PDF",.T.)
Local cDestino	 := fwGetProfString(cSession,"DEFAULT","c:\temp\",.T.)
Local nFlags   	 := PD_ISTOTVSPRINTER + PD_DISABLEORIENTATION
Local aRegs      := {}
Local ij, jj
	
/*
��������������������������������������������������������������Ŀ
� Define Variaveis Private(Basicas)                            �
����������������������������������������������������������������*/
Private nomeprog := 'PONR010'
Private nLastKey := 0
Private cPerg    := Padr(AllTrim('PRTPONR1'),10)

/*
��������������������������������������������������������������Ŀ
� Define variaveis Private utilizadas no programa RDMAKE ImpEsp�
����������������������������������������������������������������*/
Private aImp      := {}
Private aTotais   := {}
Private aAbonados := {}
Private nImpHrs   := 0

/*
��������������������������������������������������������������Ŀ
� Variaveis Utilizadas na funcao IMPR                          �
����������������������������������������������������������������*/
Private Titulo   := OemToAnsi(STR0001 ) // 'Espelho do Ponto'

/*
��������������������������������������������������������������Ŀ
� Define Variaveis Private(Programa)                           �
����������������������������������������������������������������*/
Private dPerIni  := Ctod("//")
Private dPerFim  := Ctod("//")
Private cMenPad1 := Space(30)
Private cMenPad2 := Space(19)
Private cFilSPA	 := xFilial("SPA", SRA->RA_FILIAL)
Private nOrdem   := 1
Private aInfo    := {}
Private aTurnos  := {}
Private aPrtTurn := {}
Private nColunas := 0
Private aNaES	 := {}
Private nCol	 := 0
Private nColTot	 := 0
Private nLinTot	 := 0
Private aMargRel := {}
Private nLin	 := 0
Private nPxData	 :=	0
Private nPxSemana:= 0
Private nPxAbonos:= 0
Private nPxHe	 := 0
Private nPxFalta := 0
Private nPxAdnNot:= 0
Private nPxObser := 0
Private lImpMarc := .T.
Private lCodeBar := .F.
Private lBigLine := .T.

DEFAULT lTerminal := .F.

#DEFINE Imp_Spool      	2
#DEFINE ALIGN_H_LEFT   	0
#DEFINE ALIGN_H_RIGHT  	1
#DEFINE ALIGN_H_CENTER 	2
#DEFINE ALIGN_V_CENTER 	0
#DEFINE ALIGN_V_TOP	   	1
#DEFINE ALIGN_V_BOTTON 	2
#DEFINE oFontT20		TFont():New( "Verdana", 20, 20, , .T., , , , .T., .F. )//Titulo 14
#DEFINE oFontT 			TFont():New( "Verdana", 12, 12, , .T., , , , .T., .F. )//Titulo
#DEFINE oFontP 			TFont():New( "Verdana", 10, 10, , .T., , , , .T., .F. )//Linhas
#DEFINE oFontM 			TFont():New( "Verdana", 08, 08, , .F., , , , .T., .F. )//Marcacoes
#DEFINE oFontM8N		TFont():New( "Verdana", 08, 08, , .T., , , , .T., .F. )//Marcacoes
#DEFINE oFontMN			TFont():New( "Verdana", 07, 07, , .T., , , , .T., .F. )//Marcacoes
#DEFINE oFont06 		TFont():New( "Verdana", 06, 06, , .T., , , , .T., .F. )//CodeBar

lPortal   := IF( lPortal == NIL , .F. , lPortal )   

aAdd(aRegs,{cPerg,"01","Filial De ?","�De Sucursal ?","From Branch ?","mv_ch1","C",6,0,0,"G","","mv_par01","","","","01","","","","","","","","","","","","","","","","","","","","","XM0","S","033",".RHFILDE.","",""})
aAdd(aRegs,{cPerg,"02","Filial At� ?","�A Sucursal ?","To Branch ?","mv_ch2","C",6,0,0,"G","NaoVazio()","mv_par02","","","","01","","","","","","","","","","","","","","","","","","","","","XM0","S","033",".RHFILAT.","",""})
aAdd(aRegs,{cPerg,"03","Centro de Custo De ?","�De Centro de Costo ?","From Cost Center ?","mv_ch3","C",9,0,0,"G","","mv_par03","","","","","","","","","","","","","","","","","","","","","","","","","CTT","S","004",".RHCCDE.","",""})
aAdd(aRegs,{cPerg,"04","Centro de Custo At� ?","�A Centro de Costo ?","To Cost Center ?","mv_ch4","C",9,0,0,"G","NaoVazio()","mv_par04","","","","ZZZZZZZZZ","","","","","","","","","","","","","","","","","","","","","CTT","S","004",".RHCCAT.","",""})
aAdd(aRegs,{cPerg,"05","Turno De ?","�De Turno ?","From Shift ?","mv_ch5","C",3,0,0,"G","","mv_par05","","","","","","","","","","","","","","","","","","","","","","","","","SR6","S","",".RHTURDE.","",""})
aAdd(aRegs,{cPerg,"06","Turno At� ?","�A Turno ?","To Shift ?","mv_ch6","C",3,0,0,"G","NaoVazio()","mv_par06","","","","ZZZ","","","","","","","","","","","","","","","","","","","","","SR6","S","",".RHTURAT.","",""})
aAdd(aRegs,{cPerg,"07","Matricula De ?","�De Matricula ?","From Registration ?","mv_ch7","C",6,0,0,"G","","mv_par07","","","","000863","","","","","","","","","","","","","","","","","","","","","SRA","S","",".RHMATD.","",""})
aAdd(aRegs,{cPerg,"08","Matricula At� ?","�A Matricula ?","To Registration ?","mv_ch8","C",6,0,0,"G","NaoVazio()","mv_par08","","","","000863","","","","","","","","","","","","","","","","","","","","","SRA","S","",".RHMATA.","",""})
aAdd(aRegs,{cPerg,"09","Nome De ?","�De Nombre ?","From Name ?","mv_ch9","C",30,0,0,"G","","mv_par09","","","","","","","","","","","","","","","","","","","","","","","","","","S","",".RHNOMED.","",""})
aAdd(aRegs,{cPerg,"10","Nome At� ?","�A Nombre ?","To Name ?","mv_cha","C",30,0,0,"G","NaoVazio()","mv_par10","","","","ZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZ","","","","","","","","","","","","","","","","","","","","","","S","",".RHNOMEA.","",""})
aAdd(aRegs,{cPerg,"11","Situa��es a Imp. ?","�Situaciones por Imp. ?","Status to Print ?","mv_chb","C",5,0,0,"G","fSituacao","mv_par11","","",""," ADFT","","","","","","","","","","","","","","","","","","","","","","S","",".RHSITUA.","",""})
aAdd(aRegs,{cPerg,"12","Categorias a Imp. ?","�Categorias por Imp. ?","Categories to Print ?","mv_chc","C",15,0,0,"G","fCategoria","mv_par12","","","","ACDEGHMPST","","","","","","","","","","","","","","","","","","","","","","S","",".RHCATEG.","",""})
aAdd(aRegs,{cPerg,"13","Imprimir   Horas ?","�Imprimir Horas ?","Print Hours ?","mv_chd","N",1,0,3,"C","","mv_par13","Calculadas","Calculadas","Calculated","","","Informadas","Informadas","Entered","","","Ambas","Ambas","Both","","","Nenhuma","Ninguna","None","","","","","","","","S","","","",""})
aAdd(aRegs,{cPerg,"14","Demonstrar Horas ?","�Mostrar horas ?","Display Hours ?","mv_che","N",1,0,3,"C","","mv_par14","Autorizadas","Autorizadas","Authorized","","","N�o","No","No","","","Ambas","Ambas","Both","","","","","","","","","","","","","S","","","",""})
aAdd(aRegs,{cPerg,"15","N�mero de C�pias ?","�Num. de Copias ?","Number of Copies ?","mv_chf","N",1,0,0,"G","","mv_par15","","","","0","","","","","","","","","","","","","","","","","","","","","","S","","","",""})
aAdd(aRegs,{cPerg,"16","Func. sem Marca�oes ?","�Empl. sin registros ?","Empl without Punches ?","mv_chg","N",1,0,1,"C","","mv_par16","Sim","S�","Yes","","","N�o","No","No","","","","","","","","","","","","","","","","","","S","","","",""})
//aAdd(aRegs,{cPerg,"17","Mensagem Padr�o ?","�Mensaje Estandar ?","Standard Message ?","mv_chh","C",30,0,0,"G","","mv_par17","","","","","","","","","","","","","","","","","","","","","","","","","","S","","","",""})
//aAdd(aRegs,{cPerg,"18","Mens. Padr�o (Cont.) ?","�Mens. Est.(Cont) ?","Standard Message (Cont.) ?","mv_chi","C",19,0,0,"G","","mv_par18","","","","","","","","","","","","","","","","","","","","","","","","","","S","","","",""})
aAdd(aRegs,{cPerg,"17","Data De ?","�A Fecha ?","From Date ?","MV_CHH","D",8,0,0,"G","(PutPerMvPar('PNR010','17','18').and.NaoVazio())","mv_par17","","","","20170120","","","","","","","","","","","","","","","","","","","","","","S","","","",""})
aAdd(aRegs,{cPerg,"18","Data At� ?","�A Fecha ?","To Date ?","MV_CHI","D",8,0,0,"G","NaoVazio()","mv_par18","","","","20170219","","","","","","","","","","","","","","","","","","","","","","S","","","",""})
aAdd(aRegs,{cPerg,"19","Horas em ?","�Horas en ?","Hours in ?","MV_CHJ","N",1,0,1,"C","","mv_par19","Sexagenal","Sexagesimal","Sexagesimal","","","Centesimal","Centesimal","Centesimal","","","","","","","","","","","","","","","","","","S","","","",""})
aAdd(aRegs,{cPerg,"20","Eventos do Result. ?","�Eventos del Result. ?","Result Events ?","MV_CHK","N",1,0,1,"C","","mv_par20","Sim","S�","Yes","","","N�o","No","No","","","","","","","","","","","","","","","","","","S","","","",""})
//aAdd(aRegs,{cPerg,"23","Impr. Troca Turnos ?","�Impr. Cambia turnos ?","Print Shift Change ?","MV_CHN","N",1,0,1,"C","","mv_par23","Sim","S�","Yes","","","N�o","No","No","","","","","","","","","","","","","","","","","","S","","","",""})
aAdd(aRegs,{cPerg,"21","Descr.Excec�o no Afast. ?","�Descr.Excep.Lic. ?","Descr Exception in Leave ?","MV_CHL","N",1,0,1,"C","","mv_par21","Sim","S�","Yes","","","N�o","No","No","","","","","","","","","","","","","","","","","","S","","","",""})
aAdd(aRegs,{cPerg,"22","Departamento De ?","�De departamento ?","Department From ?","MV_CHM","C",9,0,0,"G","","mv_par22","","","","","","","","","","","","","","","","","","","","","","","","","SQB","S","025",".RHDPTDE.","",""})
aAdd(aRegs,{cPerg,"23","Departamento At� ?","�A departamento ?","Department To ?","MV_CHN","C",9,0,0,"G","NaoVazio()","mv_par23","","","","ZZZZZZZZZ","","","","","","","","","","","","","","","","","","","","","SQB","S","025",".RHDPTAT.","",""})
aAdd(aRegs,{cPerg,"24","Imprime Marca��es ?","�Imprime registros ?","Print Punches ?","MV_CHO","N",1,0,1,"C","","mv_par24","Sim","S�","Yes","","","N�o","No","No","","","","","","","","","","","","","","","","","","S","",".PNR01027.","",""})
//aAdd(aRegs,{cPerg,"28","Imprime C�digo de Barras ?","�Imprime c�digo de barras ?","Print Bar Codes ?","MV_CHS","N",1,0,2,"C","","mv_par28","Sim","S�","Yes","","","N�o","No","No","","","","","","","","","","","","","","","","","","S","",".PNR01028.","",""})
//aAdd(aRegs,{cPerg,"29","Destacar Linhas ?","�Destacar l�neas ?","Highlight Lines ?","MV_CHT","N",1,0,2,"C","","mv_par29","Sim","S�","Yes","","","N�o","No","No","","","","","","","","","","","","","","","","","","S","",".PNR01029.","",""})
//aAdd(aRegs,{cPerg,"30",""Imprime Banco de Horas" ?","�"Imprime banco de horas" ?",""Print Comp Time" ?","MV_CHU","N",1,0,2,"C","","mv_par30","Sim","S�","Yes","","","N�o","No","No","","","","","","","","","","","","","","","","","","S","",".PNR01030.","",""})
dbSelectArea("SX1")
SX1->(dbSetOrder(1))
For ij:=1 to Len(aRegs)
	If !SX1->(dbSeek(cPerg + aRegs[ij,2]))
		RecLock("SX1",.T.)
		For jj:=1 to FCount()
			If jj <= Len(aRegs[ij])
				FieldPut(jj,aRegs[ij,jj])
			Endif
		Next
		MsUnlock()
	Endif
Next

/*
��������������������������������������������������������������Ŀ
�Par�metro MV_COLMARC										   �
����������������������������������������������������������������*/
nColunas := SuperGetmv("MV_COLMARC")
If ( nColunas == NIL )
	Help("", 1, "MVCOLNCAD")
	Return( .F. )
EndIf

/*
��������������������������������������������������������������Ŀ
�O numero de colunas eh sempre aos pares					   �
����������������������������������������������������������������*/
nColunas *= 2

/*
��������������������������������������������������������������Ŀ
� Envia controle para a funcao SETPRINT                        �
����������������������������������������������������������������*/
If !( lTerminal )
	aDevice := {}
	//���������������������������������������
	//�Define os Tipos de Impressao validos �
	//���������������������������������������
	AADD(aDevice,"DISCO") 
	AADD(aDevice,"SPOOL") 
	AADD(aDevice,"EMAIL") 
	AADD(aDevice,"EXCEL") 
	AADD(aDevice,"HTML" ) 
	AADD(aDevice,"PDF"  )  
	
	//������������������������������������������������������Ŀ
	//�Realiza as configuracoes necessarias para a impressao �
	//��������������������������������������������������������
	nPrintType := aScan(aDevice,{|x| x == cDevice }) 
	nLocal     := If( fWGetProfString( cSession, "LOCAL", "SERVER", .T. ) == "SERVER", 1, 2 )                                                                                                                                                                                                                          
	
	oSetup := FWPrintSetup():New(nFlags, Titulo)
	oSetup:SetUserParms( {|| Pergunte(cPerg, .T.) } ) 
	oSetup:SetPropert(PD_PRINTTYPE   , nPrintType)
	oSetup:SetPropert(PD_ORIENTATION , 1) 
	oSetup:SetPropert(PD_DESTINATION , nLocal)
	oSetup:SetPropert(PD_MARGIN      , {10,10,10,10})
	oSetup:SetPropert(PD_PAPERSIZE   , 2)
	oSetup:SetPropert(PD_PREVIEW,.T.)
	oSetup:SetOrderParms(aOrdem,@nOrdem)
	
	If cDevice == "PDF"
		oSetup:aOptions[PD_VALUETYPE] := cDestino
	EndIf
	
	oPrinter      	 := FWMSPrinter():New( "PNRESP", IMP_PDF , .F., , .T., , oSetup )
	
	If !(oSetup:Activate() == PD_OK)
		oPrinter:Deactivate() 
		FreeObj(oPrinter)
		Return
	EndIf
	 
	oPrinter:lServer := oSetup:GetProperty( PD_DESTINATION ) == AMB_SERVER                      
	oPrinter:SetResolution( 75 )
	
	oPrinter:SetPortrait()
	       
	oPrinter:SetPaperSize( oSetup:GetProperty( PD_PAPERSIZE ) )
	oPrinter:SetMargin(oSetup:GetProperty( PD_MARGIN )[1],oSetup:GetProperty( PD_MARGIN )[2],oSetup:GetProperty( PD_MARGIN )[3],oSetup:GetProperty( PD_MARGIN )[4])
	aMargRel := {oSetup:GetProperty( PD_MARGIN )[1],oSetup:GetProperty( PD_MARGIN )[2],oSetup:GetProperty( PD_MARGIN )[3],oSetup:GetProperty( PD_MARGIN )[4]}
	
	fwWriteProfString(cSession,"LOCAL", If(oSetup:GetProperty(PD_DESTINATION)==1,"SERVER","LOCAL"), .T.)
	fwWriteProfString(cSession,"PRINTTYPE", aDevice[oSetup:GetProperty( PD_PRINTTYPE )], .T.)
	
	If oSetup:GetProperty( PD_PRINTTYPE ) == Imp_Spool  
	
		oPrinter:nDevice := Imp_Spool
		fwWriteProfString(cSession,"DEFAULT", oSetup:aOptions[PD_VALUETYPE], .T.)
		oPrinter:cPrinter := oSetup:aOptions[PD_VALUETYPE]
		
	ElseIf oSetup:GetProperty( PD_PRINTTYPE ) == IMP_PDF
		
		oPrinter:nDevice := IMP_PDF
		fwWriteProfString(cSession,"DEFAULT", oSetup:aOptions[PD_VALUETYPE], .T.)	
		oPrinter:cPathPDF := oSetup:aOptions[PD_VALUETYPE]
		
	EndIf
EndIf

/*
��������������������������������������������������������������Ŀ
� Verifica as perguntas selecionadas                           �
����������������������������������������������������������������*/
Pergunte( cPerg , .F. )

/*
��������������������������������������������������������������Ŀ
� Carregando variaveis MV_PAR?? para Variaveis do Sistema.     �
����������������������������������������������������������������*/
FilialDe	:= IF( !lTerminal , MV_PAR01, cFilTerminal )			//Filial  De
FilialAte	:= IF( !lTerminal , MV_PAR02, cFilTerminal )			//Filial  Ate
CcDe		:= IF( !lTerminal , MV_PAR03, SRA->RA_CC   )			//Centro de Custo De
CcAte		:= IF( !lTerminal , MV_PAR04, SRA->RA_CC   )			//Centro de Custo Ate
TurDe		:= IF( !lTerminal , MV_PAR05, SRA->RA_TNOTRAB)			//Turno De
TurAte		:= IF( !lTerminal , MV_PAR06, SRA->RA_TNOTRAB)			//Turno Ate
MatDe		:= IF( !lTerminal , MV_PAR07, cMatTerminal)				//Matricula De
MatAte		:= IF( !lTerminal , MV_PAR08, cMatTerminal)				//Matricula Ate
NomDe		:= IF( !lTerminal , MV_PAR09, SRA->RA_NOME)				//Nome De
NomAte		:= IF( !lTerminal , MV_PAR10, SRA->RA_NOME)				//Nome Ate
cSit		:= IF( !lTerminal , MV_PAR11, fSituacao( NIL , .F. ))	//Situacao
cCat		:= IF( !lTerminal , MV_PAR12, fCategoria( NIL , .F. ))	//Categoria
nImpHrs		:= IF( !lTerminal , MV_PAR13, 3 )						//Imprimir horas Calculadas/Inform/Ambas/NA
nImpAut		:= IF( !lTerminal , MV_PAR14, 1 )						//Demonstrar horas Autoriz/Nao Autorizadas
nCopias		:= IF( !lTerminal , If(MV_PAR15>0,MV_PAR15,1),1)		//N�mero de C�pias
lSemMarc	:= IF( !lTerminal , (MV_PAR16==1)	, .F. )				//Imprime para Funcion�rios sem Marca�oes
cMenPad1	:= "" //IF( !lTerminal , MV_PAR17, "" )						//Mensagem padr�o anterior a Assinatura
cMenPad2	:= "" //IF( !lTerminal , MV_PAR18, "" )						//Mens. padr�o anterior a Assinatura(Cont.)
dPerIni     := IF( !lTerminal ,;
                    MV_PAR17,Stod( Subst( cPerAponta , 1 , 8 ) ))	//Data Contendo o Inicio do Periodo de Apontamento
dPerFim     := IF( !lTerminal ,;
                    MV_PAR18,Stod( Subst( cPerAponta , 9 , 8 ) ))	//Data Contendo o Fim  do Periodo de Apontamento
lSexagenal	:= IF( !lTerminal , (MV_PAR19==1), .T.  )				//Horas em  (Sexagenal/Centesimal)
lImpRes		:= IF( !lTerminal , (MV_PAR20==1), .F.	)				//Imprime eventos a partir do resultado ?
lImpTroca   := .F. //IF( !lTerminal , (MV_PAR23==1), .F.	)				//Imprime Descricao Troca de Turnos ou o Atual 
lImpExcecao := IF( !lTerminal , (MV_PAR21==1), .F.	)				//Imprime Descricao da Excecao no Lugar da do Afastamento  
DeptoDe		:= IF( !lTerminal , MV_PAR22, SRA->RA_DEPTO   )			//Departamento De
DeptoAte	:= IF( !lTerminal , MV_PAR23, SRA->RA_DEPTO   )			//Departamento Ate
lImpMarc 	:= IF( !lTerminal , MV_PAR24==1, .T.   )		 		//Imprime marca��es? .T.
lCodeBar 	:= .F. //IF( !lTerminal , MV_PAR28==1, .F.   ) 				//Imprime c�digo de barras? .F.
lBigLine 	:= .F. //IF( !lTerminal , MV_PAR29==1, .T.   ) 				//Destaca linhas? .T.

/*
��������������������������������������������������������������Ŀ
� Redefine o Tamanho das Mensagens Padroes					   �
����������������������������������������������������������������*/
cMenpad1 := IF(Empty( cMenPad1 ) , Space( 30 ) , cMenPad1 )
cMenpad2 := IF(Empty( cMenPad2 ) , Space( 19 ) , cMenPad2 )

Begin Sequence

	If ( lTerminal )
		//-- Verifica se foi possivel abrir os arquivos sem exclusividade
		If Pn090Open(@cHtml, @cAviso)
			cHtml := ""	
			cHtml := Pnr010Imp( NIL , lTerminal, lPortal, aRetPortal  )
		    /*
			��������������������������������������������������������������Ŀ
			� Apos a obtencao da consulta solicitada fecha os arquivos     �
			� utilizados no fechamento mensal para abertura exclusiva      �
			����������������������������������������������������������������*/
		    Aeval(aFilesOpen, bCloseFiles)
		Else
		   cHtml := HtmlDefault( cAviso , cHtml )   
		Endif    
	ElseIf !( nLastKey == 27 )
	
		If Pn090Open(@cHtml, @cAviso)

			If Empty( dPerIni ) .or. Empty( dPerFim )
				Help(" ",1,"PONFORAPER" , , OemToAnsi( STR0039 ) , 5 , 0  )	//'Periodo de Apontamento Invalido.'
				Break
			EndIf
	
			If !( nLastKey == 27 )
	
			    RptStatus( { |lEnd| Pnr010Imp(@lEnd, lTerminal, ,,oPrinter ) } , Titulo )
	
			EndIf
		Else
			MsgStop( cHtml, cAviso )
			cHtml := ""
		EndIf
	
	EndIf
	
End Sequence

If !lTerminal
	oPrinter:Preview()
	FreeObj(oPrinter)
EndIf
	
Return( cHtml )

/*
�����������������������������������������������������������������������������
�����������������������������������������������������������������������������
�������������������������������������������������������������������������Ŀ��
���Fun��o    � POR010Imp� Autor � EQUIPE DE RH          � Data � 07.04.96 ���
�������������������������������������������������������������������������Ĵ��
���Descri��o � Espelho do Ponto                                           ���
�������������������������������������������������������������������������Ĵ��
���Sintaxe e � Pnr010Imp(lEnd)					                          ���
�������������������������������������������������������������������������Ĵ��
���Parametros� lEnd        - A��o do Codelock                             ���
���          � cString     - Mensagem                                     ���
�������������������������������������������������������������������������Ĵ��
��� Uso      � Generico                                                   ���
��������������������������������������������������������������������������ٱ�
�����������������������������������������������������������������������������
�����������������������������������������������������������������������������*/
Static Function Pnr010Imp( lEnd , lTerminal, lPortal, aRetPortal, oPrinter )

Local aAbonosPer	:= {}
Local cOrdem		:= ""
Local cWhere		:= ""
Local cSituacao		:= ""
Local cCategoria	:= ""
Local cLastFil		:= "__cLastFil__"
Local cAcessaSRA	:= &("{ || " + ChkRH("PONR010","SRA","2") + "}")
Local cSeq			:= ""
Local cTurno		:= ""
Local cHtml			:= ""
Local cAliasSRA		:= GetNextAlias()
Local cAliasQTD		:= GetNextAlias()
Local lSPJExclu		:= !Empty( xFilial("SPJ") )
Local lSP9Exclu		:= !Empty( xFilial("SP9") )
Local nCount		:= 0.00
Local nX			:= 0.00
Local lMvAbosEve	:= .F.
Local lMvSubAbAp	:= .F.

Private aFuncFunc  := {SPACE(1), SPACE(1), SPACE(1), SPACE(1), SPACE(1), SPACE(1)}		
Private aMarcacoes := {}
Private aTabPadrao := {}
Private aTabCalend := {}
Private aPeriodos  := {}
Private aId		   := {}
Private aResult	   := {}
Private aBoxSPC	   := LoadX3Box("PC_TPMARCA") 
Private aBoxSPH	   := LoadX3Box("PH_TPMARCA")
Private cCodeBar   := ""
Private dIniCale   := Ctod("//")	//-- Data Inicial a considerar para o Calendario
Private dFimCale   := Ctod("//")	//-- Data Final a considerar para o calendario
Private dMarcIni   := Ctod("//")	//-- Data Inicial a Considerar para Recuperar as Marcacoes
Private dMarcFim   := Ctod("//")	//-- Data Final a Considerar para Recuperar as Marcacoes
Private dIniPonMes := Ctod("//")	//-- Data Inicial do Periodo em Aberto 
Private dFimPonMes := Ctod("//")	//-- Data Final do Periodo em Aberto 
Private lImpAcum   := .F.

/*
��������������������������������������������������������������Ŀ
�Como a Cada Periodo Lido reinicializamos as Datas Inicial e Fi�
�nal preservamos-as nas variaveis: dCaleIni e dCaleFim.		   �
����������������������������������������������������������������*/
dIniCale   := dPerIni   //-- Data Inicial a considerar para o Calendario
dFimCale   := dPerFim   //-- Data Final a considerar para o calendario

For nX:=1 to Len(cSit)
	If Subs(cSit,nX,1) <> "*"
		cSituacao += "'"+Subs(cSit,nX,1)+"'"
		If ( nX+1 ) <= Len(cSit)
			cSituacao += "," 
		EndIf
	EndIf
Next nX     

For nX:=1 to Len(cCat)
	If Subs(cCat,nX,1) <> "*"
		IF NX == 1
			cCategoria += "'"+Subs(cCat,nX,1)+"'"
		ELSE 
			cCategoria += ", '"+Subs(cCat,nX,1)+"'"		
		ENDIF
		/*
		If ( nX+1 ) <= Len(cCat)
			cCategoria += "," 
		EndIf
		*/
	EndIf
Next nX

/*
��������������������������������������������������������������Ŀ
�Inicializa Variaveis Static								   �
����������������������������������������������������������������*/
( CarExtAut() , RstGetTabExtra() )

//--Seleciona funcion�rios de acordo com filtros
cWhere += "%"
cWhere += "SRA.RA_FILIAL >= '" + FilialDe + "' AND "
cWhere += "SRA.RA_FILIAL <= '" + FilialAte + "' AND "
cWhere += "SRA.RA_CC >= '" + CCDe + "' AND "
cWhere += "SRA.RA_CC <= '" + CCAte + "' AND "
cWhere += "SRA.RA_TNOTRAB >= '" + TurDe + "' AND "
cWhere += "SRA.RA_TNOTRAB <= '" + TurAte + "' AND "
cWhere += "SRA.RA_MAT >= '" + MatDe + "' AND "
cWhere += "SRA.RA_MAT <= '" + MatAte + "' AND "
cWhere += "SRA.RA_NOME >= '" + NomDe + "' AND "
cWhere += "SRA.RA_NOME <= '" + NomAte + "' AND "
cWhere += "SRA.RA_DEPTO >= '" + DeptoDe + "' AND "
cWhere += "SRA.RA_DEPTO <= '" + DeptoAte + "'"
If !Empty( cSituacao )
	cWhere += " AND SRA.RA_SITFOLH IN ( " + cSituacao + ") " 
EndIf
If !Empty(cCategoria)
	cWhere += " AND SRA.RA_CATFUNC IN ( " + cCategoria + ") "
EndIf
cWhere += " AND SRA.D_E_L_E_T_ = ' ' " 
cWhere += "%"

//'Matricula'###'Centro de Custo'###'Nome'###'Turno'###'C.Custo + Nome'###'Departamento'###'Departamento + Nome'
If ( ( nOrdem == 1 ) .or. ( lTerminal ) )
	cOrdem := "%SRA.RA_FILIAL, SRA.RA_MAT%"
ElseIf ( nOrdem == 2 )
	cOrdem := "%SRA.RA_FILIAL, SRA.RA_CC%"
ElseIf ( nOrdem == 3 )
	cOrdem := "%SRA.RA_FILIAL, SRA.RA_NOME, SRA.RA_MAT%"
ElseIf ( nOrdem == 4 )
	cOrdem := "%SRA.RA_FILIAL, SRA.RA_TNOTRAB%"
ElseIf ( nOrdem == 5 )
	cOrdem := "%SRA.RA_FILIAL, SRA.RA_CC, SRA.RA_NOME%"
ElseIf ( nOrdem == 6 )
	cOrdem := "%SRA.RA_FILIAL, SRA.RA_DEPTO, SRA.RA_MAT%"
ElseIf ( nOrdem == 7 )
	cOrdem := "%SRA.RA_FILIAL, SRA.RA_DEPTO, SRA.RA_NOME%"
EndIf

BeginSql Alias cAliasSRA

 	SELECT SRA.RA_FILIAL, SRA.RA_MAT
	FROM 
		%Table:SRA% SRA
	WHERE %Exp:cWhere%
	ORDER BY %Exp:cOrdem%	

EndSql 	

/*
��������������������������������������������������������������Ŀ
�Inicializa R�gua de Impress�o								   �
����������������������������������������������������������������*/
If !( lTerminal )
	BeginSql Alias cAliasQTD
	
	 	SELECT Count(*) AS QTDREG
		FROM 
			%Table:SRA% SRA
		WHERE %Exp:cWhere%
	EndSql
	 	
	SetRegua( (cAliasQTD)->QTDREG )
	(cAliasQTD)->(DbCloseArea())
EndIf

If lCodeBar
	DbSelectArea("RS4")
	DbSetOrder(1)
EndIf

dbSelectArea('SRA')
SRA->( dbSetOrder( 1 ) )	

/*
��������������������������������������������������������������Ŀ
�Processa o Cadastro de Funcionarios						   �
����������������������������������������������������������������*/
While (cAliasSRA)->( !Eof() )

	//Posiciona no funcion�rio atual
	SRA->(DbSeek((cAliasSRA)->RA_FILIAL + (cAliasSRA)->RA_MAT))
	
	/*
	��������������������������������������������������������������Ŀ
	�So Faz Validacoes Quando nao for Terminal					   �
	����������������������������������������������������������������*/
	If !( lTerminal ) 
	
		/*
		��������������������������������������������������������������Ŀ
		�Incrementa a R�gua de Impress�o							   �
		����������������������������������������������������������������*/
		IncRegua()

		/*
		��������������������������������������������������������������Ŀ
		�Cancela a Impress�o 										   �
		����������������������������������������������������������������*/
		If ( lEnd )
			Exit
		EndIf

		/*
		��������������������������������������������������������������Ŀ
		� Consiste controle de acessos e filiais validas               �
		����������������������������������������������������������������*/
		If SRA->( !( RA_FILIAL $ fValidFil() ) .or. !Eval( cAcessaSRA ) )
			(cAliasSRA)->( dbSkip() )
			Loop
		EndIf

		/*
		��������������������������������������������������������������Ŀ
		�Consiste a data de Demiss�o								   �
		�Se o Funcionario Foi Demitido Anteriormente ao Inicio do Perio�
		�do Solicitado Desconsidera-o								   �
		����������������������������������������������������������������*/
		If !Empty(SRA->RA_DEMISSA) .and. ( SRA->RA_DEMISSA < dIniCale )
			(cAliasSRA)->( dbSkip() )
			Loop
		EndIf

	EndIf

    /*
	�������������������������������������������������������������Ŀ
	� Verifica a Troca de Filial           						  �
	���������������������������������������������������������������*/
	If !( SRA->RA_FILIAL == cLastFil )

		/*
		��������������������������������������������������������������Ŀ
		� Alimenta as variaveis com o conteudo dos MV_'S correspondetes�
		����������������������������������������������������������������*/		
		lMvAbosEve	:= ( Upper(AllTrim(SuperGetMv("MV_ABOSEVE",NIL,"N",cLastFil))) == "S" )	//--Verifica se Deduz as horas abonadas das horas do evento Sem a necessidade de informa o Codigo do Evento no motivo de abono que abona horas
		lMvSubAbAp	:= ( Upper(AllTrim(SuperGetMv("MV_SUBABAP",NIL,"N",cLastFil))) == "S" )	//--Verifica se Quando Abono nao Abonar Horas e Possuir codigo de Evento, se devera Gera-lo em outro evento e abater suas horas das Horas Calculadas
	    
	    /*
		�������������������������������������������������������������Ŀ
		� Atualiza a Filial Corrente           						  �
		���������������������������������������������������������������*/
		cLastFil := SRA->RA_FILIAL
		
	    /*
		�������������������������������������������������������������Ŀ
		� Carrega periodo de Apontamento Aberto						  �
		���������������������������������������������������������������*/
		If !CheckPonMes( @dPerIni , @dPerFim , .F. , .T. , .F. , cLastFil )
			Exit
		EndIf

    	/*
		�������������������������������������������������������������Ŀ
		� Obtem datas do Periodo em Aberto							  �
		���������������������������������������������������������������*/
		GetPonMesDat( @dIniPonMes , @dFimPonMes , cLastFil )
		
    	/*
		�������������������������������������������������������������Ŀ
		�Atualiza o Array de Informa��es sobre a Empresa.			  �
		���������������������������������������������������������������*/
		aInfo := {}
		fInfo( @aInfo , cLastFil )
	
	    /*
		�������������������������������������������������������������Ŀ
		� Carrega as Tabelas de Horario Padrao						  �
		���������������������������������������������������������������*/
		If ( lSPJExclu .or. Empty( aTabPadrao ) )
			aTabPadrao := {}
			fTabTurno( @aTabPadrao , If( lSPJExclu , cLastFil , NIL ) )
		EndIf

    	/*
		�������������������������������������������������������������Ŀ
		� Carrega TODOS os Eventos da Filial						  �
		���������������������������������������������������������������*/
		If ( Empty( aId ) .or. ( lSP9Exclu ) )
			aId := {}
			CarId( fFilFunc("SP9") , @aId , "*" )
		EndIf

	EndIf

   	/*
	�������������������������������������������������������������Ŀ
	�Retorna Periodos de Apontamentos Selecionados				  �
	���������������������������������������������������������������*/
	If ( lTerminal )
		dPerIni	:= dIniCale
		dPerFim := dFimCale
	EndIf
	
	aPeriodos := Monta_per( dIniCale , dFimCale , cLastFil , SRA->RA_MAT , dPerIni , dPerFim )

   	/*
	�������������������������������������������������������������Ŀ
	�Corre Todos os Periodos 									  �
	���������������������������������������������������������������*/
	naPeriodos := Len( aPeriodos )
	For nX := 1 To naPeriodos

   		/*
		�������������������������������������������������������������Ŀ
		�Reinicializa as Datas Inicial e Final a cada Periodo Lido.	  �
		�Os Valores de dPerIni e dPerFim foram preservados nas   varia�
		�veis: dCaleIni e dCaleFim.									  �
		���������������������������������������������������������������*/
        dPerIni		:= aPeriodos[ nX , 1 ]
        dPerFim		:= aPeriodos[ nX , 2 ] 

   		/*
		�������������������������������������������������������������Ŀ
		�Obtem as Datas para Recuperacao das Marcacoes				  �
		���������������������������������������������������������������*/
        dMarcIni	:= aPeriodos[ nX , 3 ]
        dMarcFim	:= aPeriodos[ nX , 4 ]

   		/*
		�������������������������������������������������������������Ŀ
		�Verifica se Impressao eh de Acumulado						  �
		���������������������������������������������������������������*/
		lImpAcum := ( dPerFim < dIniPonMes )
		   
	    /*
		�������������������������������������������������������������Ŀ
		� Retorna Turno/Sequencia das Marca��es Acumuladas			  �
		���������������������������������������������������������������*/
		If ( lImpAcum )
			If SPF->( dbSeek( SRA->( RA_FILIAL + RA_MAT ) + Dtos( dPerIni) ) ) .and. !Empty(SPF->PF_SEQUEPA)
				cTurno	:= SPF->PF_TURNOPA
				cSeq	:= SPF->PF_SEQUEPA
			Else
	    		/*
				�������������������������������������������������������������Ŀ
				� Tenta Achar a Sequencia Inicial utilizando RetSeq()�
				���������������������������������������������������������������*/
				If !RetSeq(cSeq,@cTurno,dPerIni,dPerFim,dDataBase,aTabPadrao,@cSeq) .or. Empty( cSeq )
	    			/*
					�������������������������������������������������������������Ŀ
					�Tenta Achar a Sequencia Inicial utilizando fQualSeq()		  �
					���������������������������������������������������������������*/
					cSeq := fQualSeq( NIL , aTabPadrao , dPerIni , @cTurno )
				EndIf
			EndIf

			If ( Empty(cTurno) )
				SPF->( dbSeek( SRA->( RA_FILIAL + RA_MAT ) ) )
				Do While	( !EOF() ) .AND.;
						 	( SRA->RA_FILIAL + SRA->RA_MAT == SPF->PF_FILIAL + SPF->PF_MAT )
					If ( SPF->PF_DATA >= dPerIni .AND. SPF->PF_DATA <= dPerFim )						
						cTurno	:= SPF->PF_TURNOPA
						cSeq	:= SPF->PF_SEQUEPA
						Exit
					Else
						SPF->( dbSkip() )
					EndIf
				EndDo
			EndIf
			/*
			�������������������������������������������������������������Ŀ
			�Obtem Codigo e Descricao da Funcao do Trabalhador na Epoca   �
			���������������������������������������������������������������*/			
			fBuscaCC(dMarcFim, @aFuncFunc[1], @aFuncFunc[2], Nil, .F. , .T.  ) 
			aFuncFunc[2]:= Substr(aFuncFunc[2], 1, 25)
			//fBuscaFunc(dMarcFim, @aFuncFunc[3], @aFuncFunc[4],20, @aFuncFunc[5], @aFuncFunc[6],25, .F. )
			fBuscaFunc( dMarcFim , @aFuncFunc[3], @aFuncFunc[4], @aFuncFunc[6] )
		Else
   			/*
			�������������������������������������������������������������Ŀ
			�Considera a Sequencia e Turno do Cadastro            		  �
			���������������������������������������������������������������*/
			cTurno	:= SRA->RA_TNOTRAB
			cSeq	:= SRA->RA_SEQTURN  
			/*
			�������������������������������������������������������������Ŀ
			�Obtem Codigo e Descricao da Funcao do Trabalhador     		  �
			���������������������������������������������������������������*/			
			aFuncFunc[1]:= SRA->RA_CC
			aFuncFunc[2]:= DescCc(aFuncFunc[1], SRA->RA_FILIAL, 25)
			aFuncFunc[3]:= SRA->RA_CODFUNC 
			aFuncFunc[4]:= DescFun(SRA->RA_CODFUNC , SRA->RA_FILIAL)
			aFuncFunc[6]:= DescCateg(SRA->RA_CATFUNC , 25)
		EndIf
	
	    /*
		�������������������������������������������������������������Ŀ
		� Carrega Arrays com as Marca��es do Periodo (aMarcacoes), com�
		�o Calendario de Marca��es do Periodo (aTabCalend) e com    as�	
		�Trocas de Turno do Funcionario (aTurnos)					  �	
		���������������������������������������������������������������*/
		( aMarcacoes := {} , aTabCalend := {} , aTurnos := {} )
		
		If lImpMarc   
		    /*
			�������������������������������������������������������������Ŀ
			� Importante: 												  �
			� O periodo fornecido abaixo para recuperar as marcacoes   cor�
			� respondente ao periodo de apontamentoo Calendario de 	 Marca�	
			� ��es do Periodo ( aTabCalend ) e com  as Trocas de Turno  do�	
			� Funcionario ( aTurnos ) integral afim de criar o  calendario�	
			� com as ordens correspondentes as gravadas nas marcacoes	  �	
			���������������������������������������������������������������*/
			If !GetMarcacoes(	@aMarcacoes					,;	//Marcacoes dos Funcionarios
								@aTabCalend					,;	//Calendario de Marcacoes
								@aTabPadrao					,;	//Tabela Padrao
								@aTurnos					,;	//Turnos de Trabalho
								dPerIni 					,;	//Periodo Inicial
								dPerFim						,;	//Periodo Final
								SRA->RA_FILIAL				,;	//Filial
								SRA->RA_MAT					,;	//Matricula
								cTurno						,;	//Turno
								cSeq						,;	//Sequencia de Turno
								SRA->RA_CC					,;	//Centro de Custo
								If(lImpAcum,"SPG","SP8")	,;	//Alias para Carga das Marcacoes
								NIL							,;	//Se carrega Recno em aMarcacoes
								.T.							,;	//Se considera Apenas Ordenadas
							    .T.    						,;	//Se Verifica as Folgas Automaticas
							  	.F.    			 			 ;	//Se Grava Evento de Folga Automatica Periodo Anterior
						 )
				Loop
			EndIf
		EndIf					 
	   
	    aPrtTurn:={}
	    Aeval(aTurnos, {|x| If( x[2] >= dPerIni .AND. x[2]<= dPerFim, Aadd(aPrtTurn, x),Nil )} ) 
	   
	    /*
		�������������������������������������������������������������Ŀ
		�Reinicializa os Arrays aToais e aAbonados					  �
		���������������������������������������������������������������*/
		( aTotais := {} , aAbonados := {} )

	    /*
		�������������������������������������������������������������Ŀ
		�Carrega os Abonos Conforme Periodo       					  �
		���������������������������������������������������������������*/
		If 	lImpMarc
			fAbonosPer( @aAbonosPer , dPerIni , dPerFim , cLastFil , SRA->RA_MAT )
		EndIf

	    /*
		�������������������������������������������������������������Ŀ
		�Carrega os Totais de Horas e Abonos.						  �
		���������������������������������������������������������������*/
		If 	lImpMarc	
			CarAboTot( @aTotais , @aAbonados , aAbonosPer, lMvAbosEve, lMvSubAbAp )
		EndIf
	
	    /*
		�������������������������������������������������������������Ŀ
		�Carrega o Array a ser utilizado na Impress�o.				  �
		�aPeriodos[nX,3] --> Inicio do Periodo para considerar as  mar�
		�                    cacoes e tabela						  �
		�aPeriodos[nX,4] --> Fim do Periodo para considerar as   marca�
		�                    coes e tabela							  �
		���������������������������������������������������������������*/
		If ( !fMontaAimp( aTabCalend, aMarcacoes, @aImp,dMarcIni,dMarcFim, lTerminal, lImpAcum) .and. !( lSemMarc ) )
			Loop
		EndIf

	    /*
		�������������������������������������������������������������Ŀ
		�Imprime o Espelho para um Funcionario.						  �
		���������������������������������������������������������������*/
		For nCount := 1 To nCopias
			If !( lTerminal )
				oPrinter:StartPage()
				If lCodeBar
					cCodeBar := cEmpAnt + SRA->RA_FILIAL + SRA->RA_MAT + DtoS(dPerIni) + DtoS(dPerFim) + DtoS(dDataBase) + StrTran(Time(),":","")
				EndIf
				fImpFun( aImp , nColunas, ,oPrinter )
				If lCodeBar //Grava o c�digo de barras gerado na tabela RS4
					RecLock("RS4",.T.)
					RS4->RS4_FILIAL := xFilial("RS4")
					RS4->RS4_MAT	:= SRA->RA_MAT
					RS4->RS4_PER	:= DtoS(dPerIni) + DtoS(dPerFim) 
					RS4->RS4_DATAI	:= dPerIni
					RS4->RS4_DATAF	:= dPerFim
					RS4->RS4_CODEBA	:= cCodeBar
					RS4->RS4_STATUS	:= "2" //Pendente
					MsUnLock()
				EndIf
				oPrinter:EndPage()				
			Else
				If lPortal					
					aRetPortal  := aClone(aImp)
				Else
					cHtml := fImpFun( aImp , nColunas , lTerminal )
				EndIf
		    EndIf		    
		Next nCount
	
	    /*
		�������������������������������������������������������������Ŀ
		�Reinicializa Variaveis										  �
		���������������������������������������������������������������*/
		aImp      := {}
		aTotais   := {}
		aAbonados := {}
		
	Next nX

    (cAliasSRA)->( dbSkip() )

End While

(cAliasSRA)->(DbCloseArea())


Return( cHtml )

/*
�����������������������������������������������������������������������������
�����������������������������������������������������������������������������
�������������������������������������������������������������������������Ŀ��
���Fun��o    �FImpFun   � Autor � J.Ricardo             � Data � 09/04/96 ���
�������������������������������������������������������������������������Ĵ��
���Descri��o � Imprime o espelho do ponto do funcionario                  ���
�������������������������������������������������������������������������Ĵ��
���Sintaxe   �                                                            ���
�������������������������������������������������������������������������Ĵ��
��� Uso      � POR010IMP                                                  ���
��������������������������������������������������������������������������ٱ�
�����������������������������������������������������������������������������
�����������������������������������������������������������������������������*/
Static Function fImpFun( aImp , nColunas , lTerminal, oPrinter )

Local cHtml			:= ""    
Local cOcorr		:= ""   
Local cAbHora		:= ""
Local lZebrado		:= .F.
Local nX        	:= 0.00
Local nY        	:= 0.00
Local nColMarc  	:= 0.00
Local nTamLin   	:= 0.00
Local nMin			:= 0.00
Local nLenImp		:= 0.00
Local nLenImpnX		:= 0.00
Local nTamAuxlin	:= 0.00   
Local nAbHora		:= 0
Local nPosES		:= 0
Local nValAux		:= 0
Local nContEve		:= 0
Local oBrushC	    := TBrush():New( ,  RGB(228, 228, 228)  )
Local oBrushI	    := TBrush():New( ,  RGB(242, 242, 242)  )
Local lBrush		:= .F.
Local nBhP			:= 0
Local nBhN			:= 0
Local cAlias		:= If(lImpAcum,"SPH","SPC")
Local cPrefix		:= If(lImpAcum,"PH","PC")

//-- Define o tamanho da linha com base no MV_ColMarc.
aEval(aImp, { |x| nColMarc := If(Len(x)-3>nColMarc, Len(x)-3, nColMarc) } )
nColMarc += If(nColMarc%2 == 0, 0, 1)
 
//-- Calcula a Maior das Qtdes de Colunas existentes
nColunas := Max(nColunas, nColMarc)

//-- Define configura��es da impress�o
nTamAuxLin	:= 19+(nColunas*6)+50
nTamLin    	:= If(nTamAuxLin <= 80,80,If(nTamAuxLin<=132,132,220))

If ( lTerminal )
	/*
	��������������������������������������������������������������Ŀ
	� Inicio da Estrutura do Codigo HTML						   �
	����������������������������������������������������������������*/
	cHtml += HtmlProcId() + CRLF
	cHtml += '<html>'  + CRLF
	cHtml += 	'<head>'  + CRLF
	cHtml += 		'<title>RH Online</title>'  + CRLF
	cHtml +=		'<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">'  + CRLF
	cHtml +=		'<link rel="stylesheet" href="css/rhonline.css" type="text/css">'  + CRLF
	cHtml +=	'</head>'  + CRLF
	cHtml +=	'<body bgcolor="#FFFFFF" text="#000000">' + CRLF
	cHtml +=		'<table width="515" border="0" cellspacing="0" cellpadding="0">'  + CRLF
  	cHtml +=			'<tr>'  + CRLF
    cHtml +=				'<td class="titulo">'  + CRLF
    cHtml +=					'<p>' + CRLF
    cHtml +=						'<img src="'+TcfRetDirImg()+'/icone_titulo.gif" width="7" height="9">' + CRLF
    cHtml +=							'<span class="titulo_opcao">' + CRLF
    cHtml +=								STR0040 + CRLF	//'Consultar Marca&ccedil;&otilde;es'
    cHtml +=							'</span>' + CRLF
    cHtml +=							'<br><br>' + CRLF
	cHtml +=					'</p>' + CRLF
	cHtml +=				'</td>' + CRLF
  	cHtml +=			'</tr>' + CRLF
  	cHtml +=			'<tr>' + CRLF
    cHtml +=				'<td>' + CRLF
    cHtml +=					'<table width="515" border="0" cellspacing="0" cellpadding="0">' + CRLF
    cHtml +=						'<tr>' + CRLF
    cHtml +=							'<td background="'+TcfRetDirImg()+'/tabela_conteudo_1.gif" width="10">&nbsp;</td>' + CRLF
    cHtml +=							'<td class="titulo" width="498">' + CRLF
    cHtml +=								'<table width="498" border="0" cellspacing="2" cellpadding="1">' + CRLF
	cHtml += Imp_Cabec( nTamLin , nColunas , lTerminal )
Else
	//-- Imprime Cabecalho Especifico.
	Imp_Cabec( nTamLin , nColunas ,  lTerminal, 1, oPrinter )
EndIf

//-- Imprime Marca��es
nLenImp := Len(aImp)
For nX := 1 To nLenImp
	If !( lTerminal )
		nLin += 12
		
		If nLin > nLinTot - 40
			fImpSign(oPrinter)
			oPrinter:EndPage()
			oPrinter:StartPage()
			Imp_Cabec( nTamLin , nColunas ,  lTerminal, 1, oPrinter )
		EndIf

		If aImp[nX,1] == ctod("15/03/2017")
			Parou := .t.
		EndIf
	
		oPrinter:Box( nLin, nCol	, nLin+13, nColTot-15, "-6" )			// Caixa da linha total
		
		If lBigLine .and. nX%2 == 0 //Pinta somente as linhas pares
			oPrinter:Fillrect( {nLin+1, nCol+1, nLin+12, nColTot-1 }, oBrushI, "-2") // Quadro na Cor Cinza
		EndIf
		
		//oPrinter:Line( nLin, nPxData	, nLin+13, nPxData	, 0 , "-6") 	// Linha Pos Data

		oPrinter:SayAlign(nLin,nCol+6,Strzero(Day(aImp[nX,1]),2),oFontMN,500,100,,ALIGN_H_LEFT)
		oPrinter:SayAlign(nLin,nCol+30,Left(DiaSemana(aImp[nX,1],8),3),oFontMN,nPxSemana-nPxData,100,,ALIGN_H_LEFT)
		
		nMin := Len(aImp[nX])
				
		If Len(aImp[nX]) >= 4 .or. !lImpMarc
		
			For nPosES := 1 to Len(aNaES)                                
			
				//oPrinter:Line( nLin, aNaES[nPosES]-6, nLin+13, aNaES[nPosES]-6, 0 , "-6")	
				nY := nPosES + 3
				If lImpMarc .and. nY <= nMin
					oPrinter:SayAlign(nLin,aNaES[nPosES]+2,aImp[nX,nY],oFontMN,500,100,,ALIGN_H_LEFT)
				EndIf
			Next nPosES
		Else
			//oPrinter:Line( nLin, aNaES[1]-6, nLin+13, aNaES[1]-6, 0 , "-6")

	    	cMsgAusente := ""
	    	If Alltrim(aImp[nX,2]) == STR0020  // '** Ausente **'
				nRecAntA := ( cAlias )->(Recno())
				If ( cAlias )->(dbSeek( SRA->RA_FILIAL + SRA->RA_MAT ) )
					While !(cAlias)->( Eof() ) .and. (cAlias)->(&(cPrefix+"_FILIAL")+&(cPrefix+"_MAT") ) == SRA->RA_FILIAL + SRA->RA_MAT
						If (cAlias)->(&(cPrefix+"_DATA")) == aImp[nX,1]
							If (cAlias)->(&(cPrefix+"_PDI")) == "066"
								cMsgAusente := "Banco de Horas"
							EndIf
						EndIf
						(cAlias)->( DbSkip() )
					EndDo
				EndIf
				( cAlias )->(DbGoTo(nRecAntA))
			EndIf

			If Empty(cMsgAusente)
				oPrinter:SayAlign(nLin,nCol+460,aImp[nX,2],oFontMN,Len(aNaES)*40,100,,ALIGN_H_LEFT)
			Else
				oPrinter:SayAlign(nLin,nCol+460,cMsgAusente,oFontMN,Len(aNaES)*40,100,,ALIGN_H_LEFT)
			EndIf
		EndIf
		
		//oPrinter:Line( nLin, nPxAbonos-6, nLin+13	, nPxAbonos-6, 0 , "-6")
		//oPrinter:Line( nLin, nPxHE-6	, nLin+13	, nPxHE-6, 0 , "-6")
		//oPrinter:Line( nLin, nPxFalta-6	, nLin+13	, nPxFalta-6, 0 , "-6")
		//oPrinter:Line( nLin, nPxAdnNot-6, nLin+13	, nPxAdnNot-6, 0 , "-6")
		//oPrinter:Line( nLin, nPxObser	, nLin+13	, nPxObser, 0 , "-6")		

		If lImpMarc //Imprime abonos,He,Faltas,adicionais apenas se for para imprimir marca��es.
			If ValType(aImp[nX,3]) == "A"
				//oPrinter:SayAlign(nLin,nCol+53,Alltrim(aImp[nX,3,2]),oFontMN,500,100,,ALIGN_H_LEFT) // Abono
				oPrinter:SayAlign(nLin,nCol+53,Alltrim(aImp[nX,3,2])+" "+Alltrim(aImp[nX,3,1]),oFontMN,500,100,,ALIGN_H_LEFT) // Observacao
			Else
				If Len(aImp[nX]) < 4 .and. Empty(aImp[nX,2])
					oPrinter:SayAlign(nLin,nCol+53,Alltrim(aImp[nX,3]),oFontMN,Len(aNaES)*40,100,,ALIGN_H_LEFT) // Marcacao
				Else
					If Len(aImp[nX]) >= 4 .or. !lImpMarc
						oPrinter:SayAlign(nLin,nCol+460,aImp[nX,3],oFontMN,500,100,,ALIGN_H_LEFT) // Observacao
					Else
						oPrinter:SayAlign(nLin,nCol+53,aImp[nX,3],oFontMN,500,100,,ALIGN_H_LEFT) // Observacao
					EndIf
				EndIf
			EndIf
			
			If Len(aResult) > 0
				nValAux := 0
				Aeval(aResult, {|x| If( x[1] == DtoS(aImp[nX,1]) .and. x[2] == "1", nValAux += x[3],Nil )} )
				If nValAux > 0
					oPrinter:SayAlign(nLin,nCol+290,StrTran(StrZero(nValAux,5,2),'.',':'),oFontMN,500,100,,ALIGN_H_LEFT) // hora extra
					nValAux := 0
				EndIf
				Aeval(aResult, {|x| If( x[1] == DtoS(aImp[nX,1]) .and. x[2] == "3", nValAux += x[3],Nil )} )
				If nValAux > 0
					oPrinter:SayAlign(nLin,nCol+330,StrTran(StrZero(nValAux,5,2),'.',':'),oFontMN,500,100,,ALIGN_H_LEFT) // ad not
					nValAux := 0
				EndIf
				Aeval(aResult, {|x| If( x[1] == DtoS(aImp[nX,1]) .and. x[2] =="2", nValAux += x[3],Nil )} )
				If nValAux > 0
					oPrinter:SayAlign(nLin,nCol+370,StrTran(StrZero(nValAux,5,2),'.',':'),oFontMN,500,100,,ALIGN_H_LEFT) // faltas
					nValAux := 0
				EndIf

				Aeval(aResult, {|x| If( x[1] == DtoS(aImp[nX,1]) .and. x[2] =="4", nValAux += x[3],Nil )} )
				oPrinter:SayAlign(nLin,nCol+405,StrTran(StrZero(nValAux,5,2),'.',':'),oFontMN,500,100,,ALIGN_H_LEFT) // banco positivo
				nBhP := SomaHoras(nBhP,nValAux)
				nValAux := 0

				Aeval(aResult, {|x| If( x[1] == DtoS(aImp[nX,1]) .and. x[2] =="5", nValAux += x[3],Nil )} )
				oPrinter:SayAlign(nLin,nCol+430,StrTran(StrZero(nValAux,5,2),'.',':'),oFontMN,500,100,,ALIGN_H_LEFT) // banco negativo
				nBhN := SomaHoras(nBhN,nValAux)
				nValAux := 0
			EndIf
		EndIf							                                                                   
	Else
		/*
		��������������������������������������������������������������Ŀ
		� Detalhes do Codigo HTML          							   �
		����������������������������������������������������������������*/
		IF ( lZebrado := ( nX%2 == 0.00 ) )
			cHtml += '<tr bgcolor="#FAFBFC">' + CRLF
			cHtml += 	'<td class="dados_2" bgcolor="#FAFBFC" nowrap><div align="center">' + CRLF
			cHtml += 		Dtoc(aImp[nX,1]) + CRLF
			cHtml += 	'</td>' + CRLF
			cHtml += 	'<td class="dados_2" bgcolor="#FAFBFC" nowrap><div align="left">' + CRLF
			cHtml +=		DiaSemana(aImp[nX,1]) + CRLF
			cHtml += 	'</td>' + CRLF
		Else
			cHtml += '<tr>' + CRLF
			cHtml += 	'<td class="dados_2" nowrap><div align="center">' + CRLF
			cHtml += 		Dtoc(aImp[nX,1]) + CRLF
			cHtml += 	'</td>' + CRLF
			cHtml += 	'<td class="dados_2" nowrap><div align="left">' + CRLF
			cHtml +=		DiaSemana(aImp[nX,1]) + CRLF
			cHtml += 	'</td>' + CRLF
		EndIF
		If ( nLenImpnX := Len(aImp[nX]) ) < ( ( nColunas + nLenImpnX ) - 1 )
			For nY := Len(aImp[nX]) To ( ( nColunas + 3 ) - 1 )
				aAdd(aImp[nX] , Space(05) )
			Next nY
		EndIf
		nLenImpnX := Len(aImp[nX])
		For nY := 4 To nLenImpnX
			IF ( lZebrado )
				cHtml += 	'<td class="dados_2" bgcolor="#FAFBFC" nowrap><div align="center">' + CRLF
				cHtml += 		aImp[nX,nY] + CRLF
				cHtml += 	'</td>' + CRLF
			Else
				cHtml += 	'<td class="dados_2" nowrap><div align="center">' + CRLF
				cHtml += 		aImp[nX,nY] + CRLF
				cHtml += 	'</td>' + CRLF
			EndIF	
		Next nY
		
		//-- Trata Abonos e Excecoes
		If ValType(aImp[nX,3]) == "A"
			nAbHora:=  At( ":" , aImp[nX,3,2] )
		Else
			nAbHora:=  At( ":" , aImp[nX,3] )
		EndIf
		 
		If nAbHora > 0 
			cOcorr :=	Capital( If (ValType(aImp[nX,3]) == "A",aImp[nX,3,1],SubStr( aImp[nX,3] , 1 , nAbHora - 3 )) ) 
			cAbHora:= 	Capital( If (ValType(aImp[nX,3]) == "A",aImp[nX,3,2],SubStr( aImp[nX,3] , nAbHora - 2 ) ) ) 
		Else                                                                      
			cOcorr :=	Capital( If (ValType(aImp[nX,3]) == "A",aImp[nX,3,1],AllTrim( aImp[nX,3] ) ))
			cAbHora:= 	'&nbsp;'	
		EndIf                                                
		
		If ( lZebrado )
			cHtml += 		'<td class="dados_2" bgcolor="#FAFBFC" nowrap><div align="center">' + CRLF
			cHtml +=			Capital( AllTrim( aImp[nX,2] ) )
			cHtml += 		'</td>' + CRLF
			cHtml += 		'<td class="dados_2" bgcolor="#FAFBFC" nowrap><div align="left">' + CRLF
			cHtml +=	 		cOcorr   						
			cHtml += 		'</td>' + CRLF
			cHtml += 		'<td class="dados_2" bgcolor="#FAFBFC" nowrap><div align="left">' + CRLF
			cHtml +=	 		cAbHora	
			cHtml += 		'</td>' + CRLF
		Else
			cHtml += 		'<td class="dados_2" nowrap><div align="center">' + CRLF
			cHtml +=			Capital( AllTrim( aImp[nX,2] ) )
			cHtml += 		'</td>' + CRLF
			cHtml += 		'<td class="dados_2" nowrap><div align="left">' + CRLF
			cHtml +=	 		cOcorr   						
			cHtml += 		'</td>' + CRLF
			cHtml += 		'<td class="dados_2" nowrap><div align="left">' + CRLF
			cHtml +=			cAbHora
			cHtml += 		'</td>' + CRLF
		EndIf	
	EndIf
Next nX

If !( lTerminal )
	
	nLin += 35	
		
	//-- Se existirem totais, e se for selecionada sua impress�o, ser�o impressos.
	If lImpMarc .and. Len(aTotais) > 0 .and. nImpHrs # 4
		If nLin > nLinTot - 40
			fImpSign(oPrinter)
			oPrinter:EndPage()
			oPrinter:StartPage()
			Imp_Cabec( nTamLin , nColunas ,  lTerminal, 0, oPrinter )
			nLin+=20
		EndIf
		
		oPrinter:Box( nLin, nCol , nLin+13, nColTot-15, "-6" )			// Caixa da linha total
		
		nTamCol	 := (nColTot - 15 - nCol) / 21
		nColCod1 := nCol + nTamCol
		nColDesc1:= nColCod1 + (nTamCol*4)
		nColCalc1:= nColDesc1 + nTamCol
		nColInf1 := nColCalc1 + nTamCol
		nColCod2 := nColInf1 + nTamCol
		nColDesc2:= nColCod2 + (nTamCol*4)
		nColCalc2:= nColDesc2 + nTamCol
		nColInf2 := nColCalc2 + nTamCol
		nColCod3 := nColInf2 + nTamCol
		nColDesc3:= nColCod3 + (nTamCol*4)
		nColCalc3:= nColDesc3 + nTamCol
		
		If lBigLine
			oPrinter:Fillrect( {nLin+1, nCol+1, nLin+13, nColTot-1-15 }, oBrushC, "-2") // Quadro na Cor Cinza
		EndIf		 
		
		oPrinter:Line( nLin, nColCod1	, nLin+13, nColCod1		, 0 , "-6")
		If nImpHrs == 1 .or. nImpHrs == 3
			oPrinter:Line( nLin, nColDesc1	, nLin+13, nColDesc1	, 0 , "-6")
		EndIf
		oPrinter:Line( nLin, nColCalc1	, nLin+13, nColCalc1	, 0 , "-6")
		oPrinter:Line( nLin, nColInf1	, nLin+13, nColInf1		, 0 , "-6")
		oPrinter:Line( nLin, nColCod2	, nLin+13, nColCod2		, 0 , "-6")
		If nImpHrs == 1 .or. nImpHrs == 3
			oPrinter:Line( nLin, nColDesc2	, nLin+13, nColDesc2	, 0 , "-6")
		EndIf
		oPrinter:Line( nLin, nColCalc2	, nLin+13, nColCalc2	, 0 , "-6")
		oPrinter:Line( nLin, nColInf2	, nLin+13, nColInf2		, 0 , "-6")
		oPrinter:Line( nLin, nColCod3	, nLin+13, nColCod3		, 0 , "-6")
		If nImpHrs == 1 .or. nImpHrs == 3
			oPrinter:Line( nLin, nColDesc3	, nLin+13, nColDesc3	, 0 , "-6")
		EndIf
		oPrinter:Line( nLin, nColCalc3	, nLin+13, nColCalc3	, 0 , "-6")

		oPrinter:SayAlign(nLin,nCol+2,STR0064,oFontP,500,100,,ALIGN_H_LEFT)				//Codigo
		oPrinter:SayAlign(nLin,nColCod1+2,STR0065,oFontP,500,100,,ALIGN_H_LEFT)			//Descri��o
		
		If nImpHrs == 1 .or. nImpHrs == 3
			oPrinter:SayAlign(nLin,nColDesc1+2,STR0066,oFontP,500,100,,ALIGN_H_LEFT)	//Calculado
		EndIf
		
		oPrinter:SayAlign(nLin,nColCalc1+2,STR0067,oFontP,500,100,,ALIGN_H_LEFT)		//Informado
		
		oPrinter:SayAlign(nLin,nColInf1+2,STR0064,oFontP,500,100,,ALIGN_H_LEFT)			//Codigo
		oPrinter:SayAlign(nLin,nColCod2+2,STR0065,oFontP,500,100,,ALIGN_H_LEFT)			//Descri��o
		
		If nImpHrs == 1 .or. nImpHrs == 3		
			oPrinter:SayAlign(nLin,nColDesc2+2,STR0066,oFontP,500,100,,ALIGN_H_LEFT)	//Calculado
		EndIf
		oPrinter:SayAlign(nLin,nColCalc2+2,STR0067,oFontP,500,100,,ALIGN_H_LEFT)		//Informado
		
		oPrinter:SayAlign(nLin,nColInf2+2,STR0064,oFontP,500,100,,ALIGN_H_LEFT)			//Codigo
		oPrinter:SayAlign(nLin,nColCod3+2,STR0065,oFontP,500,100,,ALIGN_H_LEFT)			//Descri��o
		
		If nImpHrs == 1 .or. nImpHrs == 3		
			oPrinter:SayAlign(nLin,nColDesc3+2,STR0066,oFontP,500,100,,ALIGN_H_LEFT)	//Calculado
		EndIf
		oPrinter:SayAlign(nLin,nColCalc3+2,STR0067,oFontP,500,100,,ALIGN_H_LEFT)		
		
		nMetade := nLin
		nContEve:= 1
		For nX := 1 To Len(aTotais)
			If nContEve == 1
				nMetade+=12
				If nMetade > nLinTot - 40
					fImpSign(oPrinter)
					oPrinter:EndPage()
					oPrinter:StartPage()
					Imp_Cabec( nTamLin , nColunas ,  lTerminal, 2, oPrinter )
					nLin+=12
				EndIf
				oPrinter:Box(  nMetade, nCol	, nMetade+13, nColTot-15	, "-6" )
				If lBigLine .and. lBrush
					oPrinter:Fillrect( {nMetade+1, nCol+1, nMetade+12, nColTot-1-15 }, oBrushI, "-2") // Quadro na Cor Cinza
					lBrush := .F.
				Else
					lBrush := .T.
				EndIf				
				oPrinter:Line( nMetade, nColCod1	, nMetade+13, nColCod1	, 0 , "-6")
				oPrinter:Line( nMetade, nColDesc1	, nMetade+13, nColDesc1	, 0 , "-6")
				oPrinter:Line( nMetade, nColCalc1	, nMetade+13, nColCalc1	, 0 , "-6")
				oPrinter:Line( nMetade, nColInf1	, nMetade+13, nColInf1	, 0 , "-6")
				oPrinter:Line( nMetade, nColCod2	, nMetade+13, nColCod2	, 0 , "-6")
				oPrinter:Line( nMetade, nColDesc2	, nMetade+13, nColDesc2	, 0 , "-6")
				oPrinter:Line( nMetade, nColCalc2	, nMetade+13, nColCalc2	, 0 , "-6")
				oPrinter:Line( nMetade, nColInf2	, nMetade+13, nColInf2	, 0 , "-6")
				oPrinter:Line( nMetade, nColCod3	, nMetade+13, nColCod3	, 0 , "-6")
				oPrinter:Line( nMetade, nColDesc3	, nMetade+13, nColDesc3	, 0 , "-6")
				oPrinter:Line( nMetade, nColCalc3	, nMetade+13, nColCalc3	, 0 , "-6")
				
				oPrinter:SayAlign(nMetade,nCol+2,aTotais[nX,1],oFontM,500,100,,ALIGN_H_LEFT)
				oPrinter:SayAlign(nMetade,nColCod1+2,aTotais[nX,2],oFontM,500,100,,ALIGN_H_LEFT)
				oPrinter:SayAlign(nMetade,nColDesc1,aTotais[nX,3],oFontM,500,100,,ALIGN_H_LEFT)
				oPrinter:SayAlign(nMetade,nColCalc1,aTotais[nX,4],oFontM,500,100,,ALIGN_H_LEFT)
				nContEve++
			ElseIf nContEve == 2
				oPrinter:SayAlign(nMetade,nColInf1+2,aTotais[nX,1],oFontM,500,100,,ALIGN_H_LEFT)
				oPrinter:SayAlign(nMetade,nColCod2+2,aTotais[nX,2],oFontM,500,100,,ALIGN_H_LEFT)
				oPrinter:SayAlign(nMetade,nColDesc2,aTotais[nX,3],oFontM,500,100,,ALIGN_H_LEFT)
				oPrinter:SayAlign(nMetade,nColCalc2,aTotais[nX,4],oFontM,500,100,,ALIGN_H_LEFT)
				nContEve++
			ElseIf nContEve == 3
				oPrinter:SayAlign(nMetade,nColInf2+2,aTotais[nX,1],oFontM,500,100,,ALIGN_H_LEFT)
				oPrinter:SayAlign(nMetade,nColCod3+2,aTotais[nX,2],oFontM,500,100,,ALIGN_H_LEFT)
				oPrinter:SayAlign(nMetade,nColDesc3,aTotais[nX,3],oFontM,500,100,,ALIGN_H_LEFT)
				oPrinter:SayAlign(nMetade,nColCalc3,aTotais[nX,4],oFontM,500,100,,ALIGN_H_LEFT)			
				nContEve++
			EndIf
			If nContEve > 3
				nContEve := 1
			EndIf
			nLin := nMetade
		Next nX
	EndIf
	
	nLin += 20
	If nLin > nLinTot - 40
		fImpSign(oPrinter)
		oPrinter:EndPage()
		oPrinter:StartPage()
		Imp_Cabec( nTamLin , nColunas ,  lTerminal, 0, oPrinter )
		nLin+=20
	EndIf
    
	NBHA := U_SLDBH(SRA->RA_FILIAL,SRA->RA_MAT,DPERINI)
	NBHF := U_SLDBH(SRA->RA_FILIAL,SRA->RA_MAT,DPERFIM+1)

	oPrinter:SayAlign(nLin,nCol,"Movimento Banco de Horas",oFontM8N,500,100,,ALIGN_H_LEFT)
	oPrinter:SayAlign(nLin+10,nCol,"SALDO ANTERIOR          ",oFontM,500,100,,ALIGN_H_LEFT)
	oPrinter:SayAlign(nLin+20,nCol,"HORAS POSITIVAS         ",oFontM,500,100,,ALIGN_H_LEFT)
	oPrinter:SayAlign(nLin+30,nCol,"HORAS NEGATIVAS         ",oFontM,500,100,,ALIGN_H_LEFT)
	oPrinter:SayAlign(nLin+40,nCol,"SALDO FINAL             ",oFontM,500,100,,ALIGN_H_LEFT)
	
	oPrinter:SayAlign(nLin+10,nCol+80,TRANSFORM(NBHA,"@E 9999.99"),oFontM,500,100,,ALIGN_H_LEFT)
	oPrinter:SayAlign(nLin+20,nCol+80,TRANSFORM(NBHP,"@E 9999.99"),oFontM,500,100,,ALIGN_H_LEFT)
	oPrinter:SayAlign(nLin+30,nCol+80,TRANSFORM(NBHN,"@E 9999.99"),oFontM,500,100,,ALIGN_H_LEFT)
	oPrinter:SayAlign(nLin+40,nCol+80,TRANSFORM(NBHF,"@E 9999.99"),oFontM,500,100,,ALIGN_H_LEFT)


	fImpSign(oPrinter)
Else
	/*
	��������������������������������������������������������������Ŀ
	� Final da Estrutura do Codigo HTML							   �
	����������������������������������������������������������������*/
    cHtml +=									'<tr>' + CRLF
    cHtml +=										'<td colspan="' + AllTrim( Str( nColunas + 5 ) ) + '" class="etiquetas_1" bgcolor="#FAFBFC"><hr size="1"></td>' + CRLF 
    cHtml +=									'</tr>' + CRLF
	cHtml +=								'</table>' + CRLF
	cHtml +=							'</td>' + CRLF
    cHtml +=							'<td background="'+TcfRetDirImg()+'/tabela_conteudo_2.gif" width="7">&nbsp;</td>' + CRLF
    cHtml +=						'</tr>' + CRLF
    cHtml +=					'</table>' + CRLF
    cHtml +=				'</td>' + CRLF
  	cHtml +=			'</tr>' + CRLF
	cHtml +=		'</table>' + CRLF
	cHtml +=		'<p align="right"><a href="javascript:self.print()"><img src="'+TcfRetDirImg()+'/imprimir.gif" width="90" height="28" hspace="20" border="0"></a></p>' + CRLF
	cHtml +=	'</body>' + CRLF
	cHtml += '</html>' + CRLF
EndIf
	
Return( cHtml )

/*
�����������������������������������������������������������������������������
�����������������������������������������������������������������������������
�������������������������������������������������������������������������Ŀ��
���Fun��o    �FMontaaIMP� aUTOR � EQUIPE DE RH          � dATA � 09/04/96 ���
�������������������������������������������������������������������������Ĵ��
���Descri��o � Monta o Vetor aImp , utilizado na impressao do espelho     ���
�������������������������������������������������������������������������Ĵ��
���Sintaxe   �                                                            ���
�������������������������������������������������������������������������Ĵ��
��� Uso      � POR010IMP                                                  ���
��������������������������������������������������������������������������ٱ�
�����������������������������������������������������������������������������
�����������������������������������������������������������������������������*/
Static Function FMontaAimp(aTabCalend, aMarcacoes, aImp,dInicio,dFim, lTerminal, lImpAcum)

Local aDescAbono := {}
Local aCodigos	 := {}
Local cTipAfas   := ""
Local cDescAfas  := ""
Local cOcorr     := ""
Local cOrdem     := ""
Local cTipDia    := ""
Local dData      := Ctod("//")
Local dDtBase    := dFim
Local lRet       := .T.
Local lFeriado   := .T.
Local lTrabaFer  := .F.
Local lAfasta    := .T.   
Local nX         := 0
Local nDia       := 0
Local nMarc      := 0
Local nLenMarc	 := Len( aMarcacoes )
Local nLenDescAb := Len( aDescAbono )
Local nTab       := 0
Local nContMarc  := 0
Local nDias		 := 0 

//-- Variaveis ja inicializadas.
aImp := {}

nDias := ( dDtBase - dInicio )
For nDia := 0 To nDias

	//-- Reinicializa Variaveis.
	dData      := dInicio + nDia
	aDescAbono := {}
	cOcorr     := ""
	cTipAfas   := ""
	cDescAfas  := ""
	cOcorr	   := ""

	If !lImpMarc	
		//-- Adiciona Nova Data a ser impressa.
		aAdd(aImp,{})
		aAdd(aImp[Len(aImp)], dData)
		aAdd(aImp[Len(aImp)], Space(1))
		nContMarc++
		Loop 
	EndIf	
	
	//-- o Array aTabcalend � setado para a 1a Entrada do dia em quest�o.
	If ( nTab := aScan(aTabCalend, {|x| x[1] == dData .and. x[4] == '1E' }) ) == 0.00
		Loop
	EndIf
	
	//-- o Array aMarcacoes � setado para a 1a Marca��o do dia em quest�o.
	nMarc := aScan(aMarcacoes, { |x| x[3] == aTabCalend[nTab, 2] })

	//-- Consiste Afastamentos, Demissoes ou Transferencias.
	If ( ( lAfasta := aTabCalend[ nTab , 24 ] ) .or. SRA->( RA_SITFOLH $ 'D�T' .and. dData > RA_DEMISSA ) )
		lAfasta		:= .T.
		cTipAfas	:= IF(!Empty(aTabCalend[ nTab , 25 ]),aTabCalend[ nTab , 25 ],fDemissao(SRA->RA_SITFOLH, SRA->RA_RESCRAI) )
		cDescAfas	:= fDescAfast( cTipAfas, Nil, Nil, SRA->( RA_SITFOLH == 'D' .and. dData > RA_DEMISSA ), aTabCalend[ nTab , 47 ] )
	EndIf

	//Verifica Regra de Apontamento ( Trabalha Feriado ? )
	lTrabaFer := ( PosSPA( aTabCalend[ nTab , 23 ] , cFilSPA , "PA_FERIADO" , 01 ) == "S" )

	//-- Consiste Feriados.
	If ( lFeriado := aTabCalend[ nTab , 19 ] )  .AND. !lTrabaFer
		cOcorr := aTabCalend[ nTab , 22 ]
	EndIf

	//-- Carrega Array aDescAbono com os Abonos ocorridos no Dia
	nLenDescAb := Len(aAbonados)
	For nX := 1 To nLenDescAb
		If aAbonados[nX,1] == dData
			aAdd(aDescAbono, { aAbonados[nX,2] , aAbonados[nX,3] , aAbonados[nX,4] })
		EndIf
	Next nX

	//-- Ordem e Tipo do dia em quest�o.
	cOrdem  := aTabCalend[nTab,2]
	cTipDia := aTabCalend[nTab,6]

    //-- Se a Data da marcacao for Posterior a Admissao
	If dData >= SRA->RA_ADMISSA
		
		If dData == ctod("15/03/2017")
			Parou := .t.
		EndIf
		
		//-- Se Afastado
		If ( lAfasta  .AND. aTabCalend[nTab,10] <> 'E' ) .OR. ( lAfasta  .AND. aTabCalend[nTab,10] == 'E' .AND. ( !lImpExcecao .OR. !aTabCalend[nTab,32] ) )
			cOcorr := cDescAfas 
		//-- Se nao for Afastado
		Else                    

		    //-- Se tiver EXCECAO para o Dia  ------------------------------------------------
			If aTabCalend[nTab,10] == 'E'			
		       //-- Se excecao trabalhada
		       If cTipDia == 'S'  
		          //-- Se nao fez Marcacao
		          If Empty(nMarc)
					 cOcorr := STR0020  // '** Ausente **'	
				  //-- Se fez marcacao	 
		          Else
		          	 //-- Motivo da Marcacao
	          		 If !Empty(aTabCalend[nTab,11])
					 	cOcorr := AllTrim(aTabCalend[nTab,11])
					 Else
					 	cOcorr := STR0018  // '** Excecao nao Trabalhada **'
					 EndIf
		          EndIf	 
		       //-- Se excecao outros dias (DSR/Compensado/Nao Trabalhado)
		       Else
 					//-- Motivo da Marcacao
		       		If !Empty(aTabCalend[nTab,11])
						cOcorr := AllTrim(aTabCalend[nTab,11])
					Else
						cOcorr := STR0018  // '** Excecao nao Trabalhada **'  
					EndIf
			   EndIf	

		    //-- Se nao Tiver Excecao  no Dia ---------------------------------------------------
		    Else    
		        //-- Se feriado 
		       	If lFeriado 
		       	    //-- Se nao trabalha no Feriado
		       	    If !lTrabaFer 
						cOcorr := If(!Empty(cOcorr),cOcorr,STR0019 ) // '** Feriado **' 
					//-- Se trabalha no Feriado
					Else                  
					    //-- Se Dia Trabalhado e Nao fez Marcacao
				    	If cTipDia == 'S' .and. Empty(nMarc)
							cOcorr := STR0020  // '** Ausente **'
				    	ElseIf cTipDia == 'D'
							cOcorr := STR0021  // '** D.S.R. **'  
						ElseIf cTipDia == 'C'
							cOcorr := STR0022  // '** Compensado **'
						ElseIf cTipDia == 'N'
							cOcorr := STR0023  // '** Nao Trabalhado **'
						EndIf
					EndIf
		    	Else                                    
		    	    //-- Se Dia Trabalhado e Nao fez Marcacao
			    	If cTipDia == 'S' .and. Empty(nMarc)
						cOcorr := STR0020  // '** Ausente **'
			    	ElseIf cTipDia == 'D'
						cOcorr := STR0021  // '** D.S.R. **'
					ElseIf cTipDia == 'C'
						cOcorr := STR0022  // '** Compensado **'
					ElseIf cTipDia == 'N'
						cOcorr := STR0023  // '** Nao Trabalhado **'
					EndIf
				
				EndIf	
		    EndIf
		EndIf
	EndIf	    
	
	nLenDescAb := Len(aDescAbono) 
	
	//-- Adiciona Nova Data a ser impressa.
	aAdd(aImp,{})
	aAdd(aImp[Len(aImp)], aTabCalend[nTab,1])

	//-- Ocorrencia na Data.
	If (lTerminal) 
		aAdd( aImp[Len(aImp)], cOcorr) 
	EndIf	
	
	//-- Abono na Data.
	If ( nLenDescAb  > 0 )
	    If !( lTerminal)
	    	If cOcorr == STR0020  // '** Ausente **'
			  	aAdd( aImp[Len(aImp)], cOcorr ) // '** Ausente **'
			Else
				If !empty(cOcorr)
					aAdd( aImp[Len(aImp)],	Space(01)) 
				  	aAdd( aImp[Len(aImp)], cOcorr )
					aAdd( aImp,{})
					aAdd( aImp[Len(aImp)], aTabCalend[nTab,1])
					aAdd( aImp[Len(aImp)],	Space(01) )
				Else                                   
					aAdd( aImp[Len(aImp)],	Space(01)) 
				EndIf	
			EndIf
	    EndIf
		For nX := 1 To nLenDescAb
			If nX == 1
				aAdd( aImp[Len(aImp)], aDescAbono[nX])
			Else
				aAdd(aImp, {})
				aAdd(aImp[Len(aImp)], aTabCalend[nTab,1]		)
				aAdd(aImp[Len(aImp)], Space(01)			 	)
				aAdd(aImp[Len(aImp)], aDescAbono[nX]			)
			EndIf
		Next nX
	Else
		If ( lTerminal ) 
			aAdd( aImp[Len(aImp)], '' )
		Else
			If cOcorr == STR0020  // '** Ausente **'
				aAdd( aImp[Len(aImp)], cOcorr) 
				aAdd( aImp[Len(aImp)], Space(01)) 
			Else
				aAdd( aImp[Len(aImp)], Space(01)) 
			  	aAdd( aImp[Len(aImp)], cOcorr )
			EndIf	
		EndIf		
	EndIf

	//-- Marca�oes ocorridas na data.
	If nMarc > 0
		While nMarc <= nLenMarc .and. cOrdem == aMarcacoes[nMarc,3]
			nContMarc ++
			aAdd( aImp[Len(aImp)], StrTran(StrZero(aMarcacoes[nMarc,2],5,2),'.',':') + If(aMarcacoes[nMarc,28]<>"O","*","") ) //Se nao for original, inclui asterisco na frente da marcacao
			nMarc ++
		End While
	EndIf

Next nDia

If lImpMarc .and. !lTerminal //Carrega o array aResult para exibicao das HE, faltas e adc. noturno.
	aResult := {}
	fGetApo(@aResult, dInicio, dFim, lImpAcum)
	
	For nX := 1 To Len(aResult)
		aResult[nX,3]:= __TimeSum( __TimeSum( aResult[ nX , 3 ] , 0 ) , 0 )
	Next nX
EndIf

lRet := If(nContMarc>=1,.T.,.F.)

Return( lRet )

/*/
�����������������������������������������������������������������������������
�����������������������������������������������������������������������������
�������������������������������������������������������������������������Ŀ��
���Fun��o    �Imp_Cabec � Autor � EQUIPE DE RH          � Data � 09/04/96 ���
�������������������������������������������������������������������������Ĵ��
���Descri��o � Imprime o cabecalho do espelho do ponto                    ���
�������������������������������������������������������������������������Ĵ��
���Sintaxe   �                                                            ���
�������������������������������������������������������������������������Ĵ��
��� Uso      � POR010IMP                                                  ���
��������������������������������������������������������������������������ٱ�
�����������������������������������������������������������������������������
�����������������������������������������������������������������������������/*/
Static Function Imp_Cabec(nTamLin ,nColunas, lTerminal, nTipoCab, oPrinter )

Local cDet			:= ""
Local cHtml			:= ""
Local lImpTurnos	:=.F.
Local nVezes		:= ( nColunas / 2 )
Local nQtdeTurno	:= 0.00
Local nX			:= 0.00
Local nTamTno		:= ( Min(TamSx3("R6_DESC")[1], nTamLin) ) - 1
Local nSizePage		:= 0
Local nColCab12		:= 0
Local nColCab13		:= 0
Local nVarAux		:= 0
Local nESAux		:= 0
Local oBrush		:= TBrush():New( ,  RGB(228, 228, 228)  )

DEFAULT lTerminal := .F.
DEFAULT nTipoCab  := 3 // 1 - Cab para as Marcacoes / 2 - Totais / 3 - Sem Cab Auxiliar

lImpTurnos := nTipoCab <> 2

If !( lTerminal )

	nSizePage	:= oPrinter:nPageWidth / oPrinter:nFactorHor //Largura da p�gina em cm dividido pelo fator horizontal, retorna tamanho da p�gina em pixels
	nLin		:= aMargRel[2] + 5
	nCol		:= aMargRel[1] + 10
	nPxData	 	:= nCol+50
	nPxSemana	:= nPxData+50
	nVarAux		:= 70
	nColTot		:= nSizePage-(aMargRel[1]+aMargRel[3])
	nLinTot		:= (oPrinter:nPageHeight / oPrinter:nFactorVert) - (aMargRel[2]+aMargRel[4])
	nColCab12	:= nColTot / 3
	nColCab13	:= ( nColTot / 3 ) * 2
	aNaES		:= Array(nColunas)
	
	For nX := 1 to Len(aNaES)
		aNaES[nX] := nVarAux
		nVarAux += 28
	Next nX
	
	nPxAbonos 	:= nVarAux
	nPxHe	 	:= nPxAbonos + 40
	nPxFalta 	:= nPxHe + 40
	nPxAdnNot	:= nPxFalta + 40
	nPxObser  	:= nPxAdnNot + 40 

	If lCodeBar
		If lBigLine
			oPrinter:Fillrect( {nLin, nCol, nLin+17, nColTot-210 }, oBrush, "-2") 	// Quadro na Cor Cinza
		EndIf
		oPrinter:SayAlign(nLin+2,nCol,STR0001,oFontT,nColTot-210,100,,ALIGN_H_CENTER)  	// 'Espelho do Ponto'	
	
		oPrinter:Box( nLin+3, nColTot-200	, nLin+38, nColTot-5, "-6" )				// Caixa da linha total
		oPrinter:Code128c(nLin+30, nColTot-176, cCodeBar, 20)
		oPrinter:SayAlign(nLin+30,nColTot-200,cCodeBar,oFont06,(nColTot-(nColTot-200)),100,,ALIGN_H_CENTER)
	Else
		If lBigLine
			oPrinter:Fillrect( {nLin, nCol, nLin+17, nColTot }, oBrush, "-2") 	// Quadro na Cor Cinza
		EndIf
		oPrinter:Box( nLin, nCol	, nLin+50, nColTot-15, "-6" )				// Caixa da linha total
		oPrinter:Box( nLin+52, nCol	, nLin+100, nColTot-15, "-6" )				// Caixa da linha total
		oPrinter:SayAlign(nLin+5,nCol+10,"Cartao Ponto",oFontT20,nColTot,120,,ALIGN_H_CENTER)  	// 'Espelho do Ponto'	
	EndIf
	
	cDet := "Periodo de Apuracao"
	oPrinter:SayAlign(nLin,nCol,cDet,oFontP,500,100,,ALIGN_H_LEFT)
	cDet := dToc(dPerIni)+" a "+dToC(dPerFim)
	oPrinter:SayAlign(nLin+2,nCol+100,cDet,oFontM,500,100,,ALIGN_H_LEFT)
	cDet := "Data: "
	oPrinter:SayAlign(nLin,nCol+480,cDet,oFontP,500,100,,ALIGN_H_LEFT)
	cDet := dToc(Date())
	oPrinter:SayAlign(nLin+2,nCol+520,cDet,oFontM,500,100,,ALIGN_H_LEFT)

	nLin += 12
	cDet := "CNPJ"
	oPrinter:SayAlign(nLin,nCol,cDet,oFontP,500,100,,ALIGN_H_LEFT)
	cDet := PADR(Transform( If(Len(aInfo)>0,aInfo[08],SM0->M0_CGC),'@R ##.###.###/####-##'),50)
	oPrinter:SayAlign(nLin+2,nCol+100,cDet,oFontM,500,100,,ALIGN_H_LEFT)

	nLin += 12
	cDet := "Empregador"
	oPrinter:SayAlign(nLin,nCol,cDet,oFontP,500,100,,ALIGN_H_LEFT)
	cDet := PADR( If(Len(aInfo)>0,aInfo[03],SM0->M0_NomeCom) , 50)
	oPrinter:SayAlign(nLin+2,nCol+100,cDet,oFontM,500,100,,ALIGN_H_LEFT)
	
	nLin += 12
	cDet := "Endereco"
	oPrinter:SayAlign(nLin,nCol,cDet,oFontP,500,100,,ALIGN_H_LEFT)
	cDet := PADR( If(Len(aInfo)>0,aInfo[04],SM0->M0_EndCob) , 50)
	oPrinter:SayAlign(nLin+2,nCol+100,cDet,oFontM,500,100,,ALIGN_H_LEFT)
	
	//nLin += 15
	
	//oPrinter:Line(nLin,nCol,nLin,nColTot)
	
	nLin += 15
	cDet := "Empregado"
	oPrinter:SayAlign(nLin,nCol,cDet,oFontP,500,100,,ALIGN_H_LEFT)
	cDet := SRA->RA_MAT + " " + SRA->RA_Nome
	oPrinter:SayAlign(nLin+2,nCol+100,cDet,oFontM,500,100,,ALIGN_H_LEFT)
	cDet := "Admissao"
	oPrinter:SayAlign(nLin,nCol+340,cDet,oFontP,500,100,,ALIGN_H_LEFT)
	cDet := dToc(SRA->RA_ADMISSA)
	oPrinter:SayAlign(nLin+2,nCol+385,cDet,oFontM,500,100,,ALIGN_H_LEFT)
	cDet := "CTPS/Serie"
	oPrinter:SayAlign(nLin,nCol+450,cDet,oFontP,500,100,,ALIGN_H_LEFT)
	cDet := RTRIM(SRA->RA_NUMCP)+"/"+SRA->RA_SERCP
	oPrinter:SayAlign(nLin+2,nCol+510,cDet,oFontM,500,100,,ALIGN_H_LEFT)
	
	nLin += 13
	cDet := STR0077
	oPrinter:SayAlign(nLin,nCol,cDet,oFontP,500,100,,ALIGN_H_LEFT)
	cDet := PADR(AllTrim(aFuncFunc[1]) + ' - ' + aFuncFunc[2] , 50)
	oPrinter:SayAlign(nLin+2,nCol+100,cDet,oFontM,500,100,,ALIGN_H_LEFT)
	
	cDet := STR0076
	oPrinter:SayAlign(nLin,nCol+340,cDet,oFontP,500,100,,ALIGN_H_LEFT)
	cDet := aFuncFunc[4]
	oPrinter:SayAlign(nLin+2,nCol+385,cDet,oFontM,500,100,,ALIGN_H_LEFT)
	
	nLin += 13
	//oPrinter:Line(nLin,nCol,nLin,nColTot)
	
	nLin += 5
		
	//-- Imprime Trocas de turnos
	nQtdeTurno:=Len(aPrtTurn)
	
	If !lImpTroca .OR. nQtdeTurno<2   //-- Imprime Somente a descricao do turno atual
	   If !lImpTroca .OR. nQtdeTurno == 0 //-- Periodo Atual ou Superior
	   	  cDet := STR0079  + AllTrim(SRA->RA_TnoTrab) + ' ' + fDescTno(SRA->RA_FILIAL,SRA->RA_TnoTrab, nTamTno) 
	   Else	 //Periodo Anterior 
		  cDet := STR0079  + AllTrim(Alltrim(aPrtTurn[1,1])) + ' ' + fDescTno(SRA->RA_FILIAL,aPrtTurn[1,1], nTamTno)
	   EndIf
	   oPrinter:SayAlign(nLin+2,nCol,cDet,oFontP,500,100,,ALIGN_H_LEFT)
	   //cDet := STR0060 + ": " + AllTrim(SRA->RA_DEPTO) + " - " + fDesc("SQB",SRA->RA_DEPTO,"QB_DESCRIC")
	   //oPrinter:SayAlign(nLin,nCol,cDet,oFontP,500,100,,ALIGN_H_LEFT)
	Else
        If lImpTurnos // Se for o mesmo funcionario nao imprime trocas de turnos a partir da 2 pagina
        	//-- Imprime Trocas de Turnos no Periodo
			For nX := 1 To nQtdeTurno
				cDet:= If(nX==1,STR0049,SPACE(Len(STR0049)))
		    	cDet:= cDet+DTOC(aPrtTurn[nX,2])+" "+STR0048+Alltrim(aPrtTurn[nX,1])+": "+fDescTno( SRA->RA_FILIAL, aPrtTurn[nX,1], nTamTno)
		    	oPrinter:SayAlign(nLin,nColCab12,cDet,oFontP,500,100,,ALIGN_H_LEFT)
		    	If nX == 1
		    		cDet := ' ' + STR0060 + ": " + AllTrim(SRA->RA_DEPTO)  + " - " + fDesc("SQB",SRA->RA_DEPTO,"QB_DESCRIC") // 'Departamento: '
		    		oPrinter:SayAlign(nLin,nCol,cDet,oFontP,500,100,,ALIGN_H_LEFT)
		    	EndIf
			Next nX 
		EndIf	
	EndIf
	
	If nTipoCab==1 //Monta e Imprime Cabecalho das Marcacoes
	
		// Desenho do cabecalho //
		oPrinter:Box( nLin+=18, nCol	, nLin+22, nColTot-15, "-6" )				// Caixa da linha total

		If lBigLine
			oPrinter:Fillrect( {nLin+1, nCol+1, nLin+17, nColTot-1 }, oBrush, "-2") // Quadro na Cor Cinza
		EndIf
		
		//oPrinter:Line( nLin, nPxData	, nLin+20, nPxData	, 0 , "-6") 		// Linha Pos Data
		
		//For nX := 1 to Len(aNaES)
		//	oPrinter:Line( nLin, aNaES[nX]-6	, nLin+20	, aNaES[nX]-6, 0 , "-6")			// Linha Pos Na. Entrada/Sa�da
		//Next nX
		
		//oPrinter:Line( nLin, nPxAbonos-6	, nLin+20	, nPxAbonos-6, 0 , "-6")
		//oPrinter:Line( nLin, nPxHe-6		, nLin+20	, nPxHe-6, 0 , "-6")
		//oPrinter:Line( nLin, nPxFalta-6	, nLin+20	, nPxFalta-6, 0 , "-6")
		//oPrinter:Line( nLin, nPxAdnNot-6	, nLin+20	, nPxAdnNot-6, 0 , "-6")
		
		//oPrinter:Line( nLin, nPxObser	, nLin+20	, nPxObser, 0 , "-6")
		
		oPrinter:SayAlign( nLin+=3 , nCol+5	, "DIA"	, oFontMN, nPxData, 150 , , ALIGN_H_LEFT ) //Data
		oPrinter:SayAlign( nLin    , nCol+30, "SEM"	, oFontMN, nPxSemana, 150 , , ALIGN_H_LEFT ) //Semana

		//nESAux := 1
		//For nX := 1 to Len(aNaES)
		//	If nX%2 == 0
		//		oPrinter:SayAlign( nLin, aNaES[nX], AllTrim(Str(nESAux)) + STR0036, oFontP, aNaES[nX]+40, 150 , , ALIGN_H_LEFT ) //Saida
		//		nESAux++
		//	Else
		//		oPrinter:SayAlign( nLin, aNaES[nX], AllTrim(Str(nESAux)) + STR0035, oFontP, aNaES[nX]+40, 150 , , ALIGN_H_LEFT ) //Entrada
		//	EndIf
		//Next nX
		
		oPrinter:SayAlign( nLin, nCol+053	, "Entr./Saida"		, oFontMN, 500, 150 , , ALIGN_H_LEFT )
		oPrinter:SayAlign( nLin, nCol+110	, "Entr./Saida"		, oFontMN, 500, 150 , , ALIGN_H_LEFT )
		oPrinter:SayAlign( nLin, nCol+167	, "Entr./Saida"		, oFontMN, 500, 150 , , ALIGN_H_LEFT )
		oPrinter:SayAlign( nLin, nCol+224	, "Entr./Saida"		, oFontMN, 500, 150 , , ALIGN_H_LEFT )

		//oPrinter:SayAlign( nLin, nCol+290	, STR0062		, oFontMN, 500, 150 , , ALIGN_H_LEFT ) //Abonos
		oPrinter:SayAlign( nLin, nCol+290	, STR0068		, oFontMN, 500, 150 , , ALIGN_H_LEFT ) //H.E.
		oPrinter:SayAlign( nLin, nCol+330	, STR0070		, oFontMN, 500, 150 , , ALIGN_H_LEFT ) //Ad. Not.
		oPrinter:SayAlign( nLin, nCol+370	, "Faltas"		, oFontMN, 500, 150 , , ALIGN_H_LEFT ) //Faltas
		oPrinter:SayAlign( nLin-6, nCol+410, "Bco Horas"	, oFontMN, 500, 150 , , ALIGN_H_LEFT ) //Bco Horas
		oPrinter:SayAlign( nLin+1, nCol+410	, "Pos / Neg"	, oFontMN, 500, 150 , , ALIGN_H_LEFT ) //Bco Horas
		oPrinter:SayAlign( nLin, nCol+460	, STR0063		, oFontMN, 500, 150 , , ALIGN_H_LEFT ) //Observa��o
	ElseIf nTipoCab == 2
		nLin += 18
		oPrinter:Box( nLin, nCol , nLin+13, nColTot-15, "-6" )			// Caixa da linha total
		
		nTamCol	 := (nColTot - nCol - 15) / 21
		nColCod1 := nCol + nTamCol
		nColDesc1:= nColCod1 + (nTamCol*4)
		nColCalc1:= nColDesc1 + nTamCol
		nColInf1 := nColCalc1 + nTamCol
		nColCod2 := nColInf1 + nTamCol
		nColDesc2:= nColCod2 + (nTamCol*4)
		nColCalc2:= nColDesc2 + nTamCol
		nColInf2 := nColCalc2 + nTamCol
		nColCod3 := nColInf2 + nTamCol
		nColDesc3:= nColCod3 + (nTamCol*4)
		nColCalc3:= nColDesc3 + nTamCol
		
		If lBigLine
			oPrinter:Fillrect( {nLin+1, nCol+1, nLin+13, nColTot-1-15 }, oBrush, "-2") // Quadro na Cor Cinza
		EndIf		 
		
		oPrinter:Line( nLin, nColCod1	, nLin+13, nColCod1		, 0 , "-6")
		If nImpHrs == 1 .or. nImpHrs == 3
			oPrinter:Line( nLin, nColDesc1	, nLin+13, nColDesc1	, 0 , "-6")
		EndIf
		oPrinter:Line( nLin, nColCalc1	, nLin+13, nColCalc1	, 0 , "-6")
		oPrinter:Line( nLin, nColInf1	, nLin+13, nColInf1		, 0 , "-6")
		oPrinter:Line( nLin, nColCod2	, nLin+13, nColCod2		, 0 , "-6")
		If nImpHrs == 1 .or. nImpHrs == 3
			oPrinter:Line( nLin, nColDesc2	, nLin+13, nColDesc2	, 0 , "-6")
		EndIf
		oPrinter:Line( nLin, nColCalc2	, nLin+13, nColCalc2	, 0 , "-6")
		oPrinter:Line( nLin, nColInf2	, nLin+13, nColInf2		, 0 , "-6")
		oPrinter:Line( nLin, nColCod3	, nLin+13, nColCod3		, 0 , "-6")
		If nImpHrs == 1 .or. nImpHrs == 3
			oPrinter:Line( nLin, nColDesc3	, nLin+13, nColDesc3	, 0 , "-6")
		EndIf
		oPrinter:Line( nLin, nColCalc3	, nLin+13, nColCalc3	, 0 , "-6")		

		oPrinter:SayAlign(nLin,nCol+2,STR0064,oFontP,500,100,,ALIGN_H_LEFT) //Codigo
		oPrinter:SayAlign(nLin,nColCod1+2,STR0065,oFontP,500,100,,ALIGN_H_LEFT) //Descricao
		
		If nImpHrs == 1 .or. nImpHrs == 3 //Calculado
			oPrinter:SayAlign(nLin,nColDesc1+2,STR0066,oFontP,500,100,,ALIGN_H_LEFT)
		EndIf
		
		oPrinter:SayAlign(nLin,nColCalc1+2,STR0067,oFontP,500,100,,ALIGN_H_LEFT) //Informado
		
		oPrinter:SayAlign(nLin,nColInf1+2,STR0064,oFontP,500,100,,ALIGN_H_LEFT) //Codigo
		oPrinter:SayAlign(nLin,nColCod2+2,STR0065,oFontP,500,100,,ALIGN_H_LEFT) //Descricao
		
		If nImpHrs == 1 .or. nImpHrs == 3 //Calculado		
			oPrinter:SayAlign(nLin,nColDesc2+2,STR0066,oFontP,500,100,,ALIGN_H_LEFT)
		EndIf
		oPrinter:SayAlign(nLin,nColCalc2+2,STR0067,oFontP,500,100,,ALIGN_H_LEFT) //Informado
		oPrinter:SayAlign(nLin,nColInf2+2,STR0064,oFontP,500,100,,ALIGN_H_LEFT) //Codigo
		oPrinter:SayAlign(nLin,nColCod3+2,STR0065,oFontP,500,100,,ALIGN_H_LEFT) //Descricao
		If nImpHrs == 1 .or. nImpHrs == 3 //Calculado		
			oPrinter:SayAlign(nLin,nColDesc3+2,STR0066,oFontP,500,100,,ALIGN_H_LEFT)
		EndIf
		oPrinter:SayAlign(nLin,nColCalc3+2,STR0067,oFontP,500,100,,ALIGN_H_LEFT)//Informado
	EndIf
Else
	/*
	��������������������������������������������������������������Ŀ
	� Monta o Cabecalho das Marcacoes							   �
	����������������������������������������������������������������*/
    cHtml +=									'<tr>' + CRLF
    cHtml +=										'<td colspan="' + AllTrim( Str( nColunas + 5 ) ) + '" class="etiquetas_1" bgcolor="#FAFBFC"><hr size="1"></td>' + CRLF
    cHtml +=									'</tr>' + CRLF
	cHtml +=									'<tr>' + CRLF
	cHtml +=											'<td class="etiquetas_1" bgcolor="#FAFBFC" nowrap>' + CRLF
    cHtml +=												'<div align="left">' + CRLF
	cHtml +=													STR0042 + CRLF	//'Data'
    cHtml +=												'</div>' + CRLF
	cHtml +=											'</td>' + CRLF
	cHtml +=											'<td class="etiquetas_1" bgcolor="#FAFBFC" nowrap>' + CRLF
    cHtml +=												'<div align="left">' + CRLF
	cHtml +=													STR0043 + CRLF	//'Dia'
    cHtml +=												'</div>' + CRLF
	cHtml +=											'</td>' + CRLF
	For nX := 1 To nVezes
		cHtml +=										'<td class="etiquetas_1" bgcolor="#FAFBFC" nowrap>' + CRLF
   		cHtml +=											'<div align="center">' + CRLF
    	cHtml +=												StrZero(nX,If(nX<10,1,2)) + STR0044 + CRLF	// '&#170;E.'
   		cHtml +=											'</div>' + CRLF
    	cHtml +=										'</td>' + CRLF
		cHtml +=										'<td class="etiquetas_1" bgcolor="#FAFBFC" nowrap>' + CRLF
   		cHtml +=											'<div align="center">' + CRLF
    	cHtml +=												StrZero(nX,If(nX<10,1,2)) + STR0045 + CRLF	//'&#170;S.'
   		cHtml +=											'</div>' + CRLF
    	cHtml +=										'</td>' + CRLF
	Next nX
	cHtml +=											'<td class="etiquetas_1" bgcolor="#FAFBFC" nowrap>' + CRLF
    cHtml +=												'<div align="left">' + CRLF
	cHtml +=													STR0046 + CRLF //'Observa&ccedil;&otilde;s
    cHtml +=												'</div>' + CRLF
	cHtml +=											'</td>' + CRLF
	cHtml +=											'<td class="etiquetas_1" bgcolor="#FAFBFC" nowrap>' + CRLF
    cHtml +=												'<div align="left">' + CRLF
	cHtml +=													STR0041 + CRLF	//'Motivo de Abono           Horas  Tipo da Marca&ccedil;&atilde;o'
    cHtml +=												'</div>' + CRLF
	cHtml +=											'</td>' + CRLF
	cHtml +=											'<td class="etiquetas_1" bgcolor="#FAFBFC" nowrap>' + CRLF
    cHtml +=												'<div align="left">' + CRLF
	cHtml +=													STR0047 + CRLF	//'Horas  Tipo da Marca&ccedil;&atilde;o'
    cHtml +=												'</div>' + CRLF
	cHtml +=											'</td>' + CRLF
    cHtml +=									'</tr>' + CRLF
    cHtml +=									'<tr>' + CRLF
    cHtml +=										'<td colspan="' + AllTrim( Str( nColunas + 5 ) ) + '" class="etiquetas_1" bgcolor="#FAFBFC"><hr size="1"></td>' + CRLF
    cHtml +=									'</tr>' + CRLF
EndIF
	
Return( cHtml )

/*
�����������������������������������������������������������������������������
�����������������������������������������������������������������������������
�������������������������������������������������������������������������Ŀ��
���Fun��o    �CarAboTot � Autor � EQUIPE DE RH          � Data � 08/08/96 ���
�������������������������������������������������������������������������Ĵ��
���Descri��o � Carrega os totais do SPC e os abonos                       ���
�������������������������������������������������������������������������Ĵ��
���Sintaxe   �                                                            ���
�������������������������������������������������������������������������Ĵ��
��� Uso      � POR010IMP                                                  ���
��������������������������������������������������������������������������ٱ�
�����������������������������������������������������������������������������
�����������������������������������������������������������������������������*/
Static Function CarAboTot( aTotais , aAbonados , aAbonosPer, lMvAbosEve, lMvSubAbAp ) 

Local aTotSpc		:= {} //-- 1-SPC->PC_PD/2-SPC->PC_QUANTC/3-SPC->PC_QUANTI/4-SPC->PC_QTABONO
Local aCodAbono		:= {}
Local cFilSP9   	:= xFilial( "SP9" , SRA->RA_FILIAL )
Local cFilSRV		:= xFilial( "SRV" , SRA->RA_FILIAL )
Local cImpHoras 	:= If(nImpHrs==1,"C",If(nImpHrs==2,"I","*")) //-- Calc/Info/Ambas
Local cAutoriza 	:= If(nImpAut==1,"A",If(nImpAut==2,"N","*")) //-- Aut./N.Aut./Ambas
Local cAliasRes		:= IF( lImpAcum , "SPL" , "SPB" )
Local cAliasApo		:= IF( lImpAcum , "SPH" , "SPC" )
Local bAcessaSPC 	:= &("{ || " + ChkRH("PONR010","SPC","2") + "}")
Local bAcessaSPH 	:= &("{ || " + ChkRH("PONR010","SPH","2") + "}")
Local bAcessaSPB 	:= &("{ || " + ChkRH("PONR010","SPB","2") + "}")
Local bAcessaSPL 	:= &("{ || " + ChkRH("PONR010","SPL","2") + "}")
Local bAcessRes		:= IF( lImpAcum , bAcessaSPH , bAcessaSPC )
Local bAcessApo		:= IF( lImpAcum , bAcessaSPL , bAcessaSPB )
Local nColSpc   	:= 0.00
Local nCtSpc    	:= 0.00
Local nPass     	:= 0.00
Local nHorasCal 	:= 0.00
Local nHorasInf 	:= 0.00
Local nX        	:= 0.00

If ( lImpRes )
	//Totaliza Codigos a partir do Resultado	
	fTotalSPB(;
				@aTotSpc		,;
				SRA->RA_FILIAL	,;
				SRA->RA_Mat		,;
				dMarcIni		,;
				dMarcFim		,;
				bAcessRes		,;
				cAliasRes		,;
				cAutoriza		 ;
			  )
	//-- Converte as horas para sexagenal quando impressao for a partir do resultado
	If ( lSexagenal )	// Sexagenal
		For nCtSpc := 1 To Len(aTotSpc)
			For nColSpc := 2 To 4
				aTotSpc[nCtSpc,nColSpc]:=fConvHr(aTotSpc[nCtSpc,nColSpc],'H')
			Next nColSpc
		Next nCtSpc
	EndIf
EndIf

//Totaliza Codigos a partir do Movimento
fTotaliza(;
			@aTotSpc,;
			SRA->RA_FILIAL,;
			SRA->RA_MAT,;
			bAcessApo,;
			cAliasApo,;
			cAutoriza,;
			@aCodAbono,;
			aAbonosPer,;
			lMvAbosEve,;
			lMvSubAbAp;
	 	)
//-- Converte as horas para Centesimal quando impressao for a partir do apontamento
If !( lImpRes ) .and. !( lSexagenal ) // Centesimal
	For nCtSpc :=1 To Len(aTotSpc)
		For nColSpc :=2 To 4
			aTotSpc[nCtSpc,nColSpc]:=fConvHr(aTotSpc[nCtSpc,nColSpc],'D')
		Next nColSpc
	Next nCtSpc
EndIf

//-- Monta Array com Totais de Horas
If nImpHrs # 4  //-- Se solicitado para Listar Totais de Horas
	For nPass := 1 To Len(aTotSpc)
		If ( lImpRes ) //Impressao dos Resultados
			//-- Se encontrar o Codigo da Verba ou For um codigo de hora extra valido de acordo com o solicitado  
			If PosSrv( aTotSpc[nPass,1] , cFilSRV , NIL , 01 )
		   	   nHorasCal 	:= aTotSpc[nPass,2] //-- Calculado - Abonado
			   nHorasInf 	:= aTotSpc[nPass,3] //-- Informado
			   If nHorasCal > 0 .and. cImpHoras $ 'C�*' .or. nHorasInf > 0 .and. cImpHoras $ 'I�*'
			  	  cHorCal := If(cImpHoras$'C�*',Transform(nHorasCal, '@E 999.99'),Space(9)) + Space(1)
				  cHorInf := If(cImpHoras$'I�*',Transform(nHorasInf, '@E 999.99'),Space(9))
				  aAdd(aTotais, { aTotSpc[nPass,1], SRV->RV_DESC , cHorCal, cHorInf } )
		  	   EndIf	
	        EndIf
		ElseIf PosSP9( aTotSpc[nPass,1] , cFilSP9 , NIL , 01 )
			//-- Impressao a Partir do Movimento
			nHorasCal 	:= aTotSpc[nPass,2] //-- Calculado - Abonado
			nHorasInf 	:= aTotSpc[nPass,3] //-- Informado
			If nHorasCal > 0 .and. cImpHoras $ 'C�*' .or. nHorasInf > 0 .and. cImpHoras $ 'I�*'
				cHorCal := If(cImpHoras$'C�*',Transform(nHorasCal, '@E 999.99'),Space(9)) + Space(1)
				cHorInf := If(cImpHoras$'I�*',Transform(nHorasInf, '@E 999.99'),Space(9))
				aAdd(aTotais, { aTotSpc[nPass,1] , DescPDPon(aTotSpc[nPass,1], cFilSP9 ) , cHorCal, cHorInf } )
			EndIf  
		EndIf
	Next nPass
	
	//-- Acrescenta as informacoes referentes aos eventos associados aos motivos de abono
	//-- Condicoes: Se nao For Impressao de Resultados 
	//-- 			e Se For para Imprimir Horas Calculadas ou Ambas
	If !( lImpRes ) .and. (nImpHrs == 1 .or. nImpHrs == 3) 
		For nX := 1 To Len(aCodAbono) 
			// Converte as horas para Centesimal
			If !( lSexagenal ) // Centesimal
				aCodAbono[nX,2]:=fConvHr(aCodAbono[nX,2],'D')
			EndIf
			aAdd(aTotais, { aCodAbono[nX,1] , DescPDPon(aCodAbono[nX,1], cFilSP9) , '  0,00'  , Transform(aCodAbono[nX,2],'@E 999.99') } )
		Next nX
	EndIf
EndIf

Return( NIL )

/*/
�����������������������������������������������������������������������������
�����������������������������������������������������������������������������
�������������������������������������������������������������������������Ŀ��
���Fun��o	 �fTotaliza � Autor � Mauricio MR           � Data � 27/05/02 ���
�������������������������������������������������������������������������Ĵ��
���Descri��o � Totalizar as Verbas do SPC (Apontamentos) /SPH (Acumulado) ���
�������������������������������������������������������������������������Ĵ��
��� Uso		 � Generico 												  ���
��������������������������������������������������������������������������ٱ�
�����������������������������������������������������������������������������
�����������������������������������������������������������������������������/*/
Static Function fTotaliza(	aTotais		,;
							cFil		,;
							cMat		,;
							bAcessa 	,;
							cAlias		,;
							cAutoriza	,;
							aCodAbono	,;
							aAbonosPer	,;
							lMvAbosEve	,;
							lMvSubAbAp 	 ;
						 )

Local aJustifica	:= {}
Local cCodigo		:= ""
Local cPrefix		:= SubStr(cAlias,-2)
Local cTno			:= ""
Local cCodExtras	:= ""
Local cEvento		:= ""
Local cPD			:= ""
Local cPDI			:= ""
Local cCC			:= ""
Local cTPMARCA		:= ""
Local lExtra		:= .T.
Local lAbHoras		:= .T.
Local nQuaSpc		:= 0.00
Local nX			:= 0.00 
Local nEfetAbono	:= 0.00
Local nQUANTC		:= 0.00
Local nQuanti		:= 0.00
Local nQTABONO		:= 0.00

If ( cAlias )->(dbSeek( cFil + cMat ) )
	While (cAlias)->( !Eof() .and. cFil+cMat == &(cPrefix+"_FILIAL")+&(cPrefix+"_MAT") )
        
        dData	:= (cAlias)->(&(cPrefix+"_DATA"))  	//-- Data do Apontamento
        cPD		:= (cAlias)->(&(cPrefix+"_PD"))    	//-- Codigo do Evento
        cPDI	:= (cAlias)->(&(cPrefix+"_PDI"))     	//-- Codigo do Evento Informado
        nQUANTC	:= (cAlias)->(&(cPrefix+"_QUANTC"))  	//-- Quantidade Calculada pelo Apontamento
        nQuanti	:= (cAlias)->(&(cPrefix+"_QUANTI"))  	//-- Quantidade Informada
        nQTABONO:= (cAlias)->(&(cPrefix+"_QTABONO")) 	//-- Quantidade Abonada
		cTPMARCA:= (cAlias)->(&(cPrefix+"_TPMARCA")) 	//-- Tipo da Marcacao
		cCC		:= (cAlias)->(&(cPrefix+"_CC")) 		//-- Centro de Custos
		
		If (cAlias)->( !Eval(bAcessa) )
			(cAlias)->( dbSkip() )
			Loop
		EndIf
		
		If dData < dMarcIni .or. dDATA > dMarcFim 
			(cAlias)->( dbSkip() )
			Loop
		EndIf
        
		 /*
		��������������������������������������������������������������Ŀ
		� Obtem TODOS os ABONOS do Evento							   �
		����������������������������������������������������������������*/
        //-- Trata a Qtde de Abonos
        aJustifica 	:= {} //-- Reinicializa aJustifica
        nEfetAbono	:=	0.00
		If nQuanti == 0 .and. fAbonos( dData , cPD , NIL , @aJustifica , cTPMARCA , cCC , aAbonosPer ) > 0
            
            //-- Corre Todos os Abonos
			For nX := 1 To Len(aJustifica)
			    
			   /*
				��������������������������������������������������������������Ŀ
				� Cria Array Analitico de Abonos com horas Convertidas.		   �
				����������������������������������������������������������������*/
				//-- Obtem a Quantidade de Horas Abonadas
				nQuaSpc := aJustifica[nX,2] //_QtAbono
				
				//-- Converte as horas Abonadas para Centesimal
				If !( lSexagenal ) // Centesimal
					nQuaSpc:= fConvHr(nQuaSpc,'D')
				EndIf
                
                //-- Cria Novo Elemento no array ANALITICO de Abonos 
				aAdd( aAbonados, {} )
				aAdd( aAbonados[Len(aAbonados)], dData )
				aAdd( aAbonados[Len(aAbonados)], DescAbono(aJustifica[nX,1],'C') )
				
				aAdd( aAbonados[Len(aAbonados)], StrTran(StrZero(nQuaSpc,5,2),'.',':') )
				aAdd( aAbonados[Len(aAbonados)], DescTpMarca(aBoxSPC,cTPMARCA))
				
				If !( lImpres )
					/*
					�������������������������������������������������������������������Ŀ
					� Trata das Informacoes sobre o Evento Associado ao Motivo corrente �
					���������������������������������������������������������������������*/ 
					//-- Obtem Evento Associado
					cEvento := PosSP6( aJustifica[nX,1] , SRA->RA_FILIAL , "P6_EVENTO" , 01 )
					If ( lAbHoras := ( PosSP6( aJustifica[nX,1] , SRA->RA_FILIAL , "P6_ABHORAS" , 01 ) $ " S" ) )
					    //-- Se o motivo abona Horas
						If ( lAbHoras )
							If !Empty( cEvento )
								If ( nPos := aScan( aCodAbono, { |x| x[1] == cEvento } ) ) > 0
									aCodAbono[nPos,2] := __TimeSum(aCodAbono[nPos,2], aJustifica[nX,2] ) //_QtAbono
								Else
									aAdd(aCodAbono, {cEvento,  aJustifica[nX,2] }) // Codigo do Evento e Qtde Abonada
								EndIf
							Else 
								/*
								�����������������������������������������������������������������������Ŀ
								� A T E N C A O: Neste Ponto deveriamos tratar o paramentro MV_ABOSEVE  �
								�                no entanto, como ja havia a deducao abaixo e caso al-  �
								�                guem migra-se da versao 609 com o cadastro de motivo   �
								�                de abonos abonando horas mas sem o codigo, deixariamos �
								�                de tratar como antes e o cliente argumentaria alteracao�
								�                de conceito.											�
								�������������������������������������������������������������������������*/ 
							    //-- Se o motivo  nao possui abono associado
							    //-- Calcula o total de horas a abonar efetivamente
							    nEfetAbono:= __TimeSum(nEfetAbono, aJustifica[nX,2] ) //_QtAbono
							EndIf
						EndIf
					Else	
						/*
						��������������������������������������������������������������Ŀ
						�Se Motivo de Abono Nao Abona Horas e o Codigo do Evento Relaci�
						�onado ao Abono nao Estiver Vazio, Eh como se fosse uma  altera�
						�racao do Codigo de Evento. Ou seja, Vai para os Totais      as�
						�Horas do Abono que serao subtraidas das Horas Calculadas (  Po�
						�deriamos Chamar esta operacao de "Informados via Abono" ).	   �
						�Para que esse processo seja feito o Parametro MV_SUBABAP  deve�
						�ra ter o Conteudo igual a "S"								   �
						����������������������������������������������������������������*/
						If ( ( lMvSubAbAp ) .and. !Empty( cEvento ) )
						   //-- Se o motivo  nao possui abono associado
						   //-- Calcula o total de horas a abonar efetivamente 
						   If ( nPos := aScan( aCodAbono, { |x| x[1] == cEvento } ) ) > 0
								aCodAbono[nPos,2] := __TimeSum(aCodAbono[nPos,2], aJustifica[nX,2] ) //_QtAbono
						   Else
								aAdd(aCodAbono, {cEvento,  aJustifica[nX,2] }) // Codigo do Evento e Qtde Abonada
						   EndIf
						   //-- O total de horas acumulado em nEfetAbono sera deduzido do 
						   //-- total de horas apontadas.
						   nEfetAbono:= __TimeSum(nEfetAbono, aJustifica[nX,2] ) //_QtAbono
						EndIf
					EndIf
				EndIf	
			Next nX 
		EndIf
        
        If !( lImpres )
	        //-- Obtem o Codigo do Evento  (Informado ou Calculado)
	        cCodigo:= If(!Empty(cPDI), cPDI, cPD )
	         
	        //-- Obtem a posicao no Calendario para a Data
	        
	        If ( nPos 	:= aScan(aTabCalend, {|x| x[1] ==dDATA .and. x[4] == '1E' }) ) > 0 
			    //-- Obtem o Turno vigente na Data
			    cTno	:=	aTabCalend[nPos,14]  
			    //-- Carrega ou recupera os codigos correspondentes a horas extras na Data
			    cCodExtras	:= ''
			    CarExtAut( @cCodExtras , cTno , cAutoriza )
			    lExtra:=.F.
			    If cCodigo$cCodExtras 
			       lExtra:=.T.
			    EndIf   
			EndIf      
	                 
	        //-- Se o Evento for Alguma HE Solicitada (Autorizada ou Nao Autorizada) 
	        //-- Ou  Valido Qquer Evento (Autorizado e Nao Autorizado)
	        //-- OU  Evento possui um identificador correspondente a Evento Autorizado ou Nao Autorizado.
			//-- Ou  Evento e' referente a banco de horas 
	        If lExtra .or. cAutoriza == '*' .or. (aScan(aId,{|aEvento| ( aEvento[1] == cCodigo .and. Right(aEvento[2],1) == cAutoriza ) .Or. ( aEvento[1] == cCodigo .And. cAutoriza == 'A' .And. Empty(aEvento[2]) .And. aEvento[4] == "S" ) }  ) > 0.00)
	           
		        //-- Procura em aTotais pelo acumulado do Evento Lido
				If ( nPos := aScan(aTotais,{|x| x[1] = cCodigo  }) ) > 0    
				   //-- Subtrai do evento a qtde de horas que efetivamente abona horas conforme motivo de abono
			       aTotais[nPos,2] := __TimeSum(aTotais[nPos,2],If(nQuanti>0, 0, __TimeSub(nQUANTC,nEfetAbono)))
				   aTotais[nPos,3] := __TimeSum(aTotais[nPos,3],nQuanti)
				   aTotais[nPos,4] := __TimeSum(aTotais[nPos,4],nQTABONO)
			    
				Else 
				   //-- Adiciona Evento em Acumulados
				   //-- Subtrai do evento a qtde de horas que efetivamente abona horas conforme motivo de abono
	           	   aAdd(aTotais,{cCodigo,If(nQuanti > 0, 0, __TimeSub(nQUANTC,nEfetAbono)), nQuanti,nQTABONO,lExtra })
	            EndIf
	        EndIf
         EndIf
		(cAlias)->( dbSkip() )
	End While
EndIf

Return( NIL )

/*/
�����������������������������������������������������������������������������
�����������������������������������������������������������������������������
�������������������������������������������������������������������������Ŀ��
���Fun��o	 �fTotalSPB � Autor � EQUIPE DE RH		    � Data � 05/06/00 ���
�������������������������������������������������������������������������Ĵ��
���Descri��o � Totaliza eventos a partir do SPB.                          ���
�������������������������������������������������������������������������Ĵ��
��� Uso		 � Generico 												  ���
��������������������������������������������������������������������������ٱ�
�����������������������������������������������������������������������������
�����������������������������������������������������������������������������/*/
Static Function fTotalSPB(aTotais,cFil,cMat,dDataIni,dDataFim,bAcessa,cAlias)

Local cPrefix := ""

cPrefix		:= SubStr(cAlias,-2)

If ( cAlias )->( dbSeek( cFil + cMat ) )
	While (cAlias)->( !Eof() .and. cFil+cMat == &(cPrefix+"_FILIAL")+&(cPrefix+"_MAT") )

		If (cAlias)->( &(cPrefix+"_DATA") < dDataIni .or. &(cPrefix+"_DATA") > dDataFim )
			(cAlias)->( dbSkip() )
			Loop
		EndIf

		If (cAlias)->( !Eval(bAcessa) )
			(cAlias)->( dbSkip() )
			Loop
		EndIf

		If ( nPos := aScan(aTotais,{|x| x[1] == (cAlias)->( &(cPrefix+"_PD") ) }) ) > 0
			aTotais[nPos,2] := aTotais[nPos,2] + (cAlias)->( &(cPrefix+"_HORAS") ) 
		Else
			aAdd(aTotais,{(cAlias)->( &(cPrefix+"_PD") ),(cAlias)->( &(cPrefix+"_HORAS") ),0,0 })
		EndIf
		(cAlias)->( dbSkip() )
	End While
EndIf

Return( NIL )

/*/
�����������������������������������������������������������������������������
�������������������������������������������������������������������������Ŀ��
���Fun��o    �LoadX3Box � Autor � Mauricio MR           � Data � 10.12.01 ���
�������������������������������������������������������������������������Ĵ��
���Descri��o � Retorna array da ComboBox                                  ���
�������������������������������������������������������������������������Ĵ��
���Parametros� cCampo - Nome do Campo                                     ���
�������������������������������������������������������������������������Ĵ��
��� Uso      � Generico                                                   ���
��������������������������������������������������������������������������ٱ�
�����������������������������������������������������������������������������
�����������������������������������������������������������������������������/*/
Static Function LoadX3Box(cCampo)

Local aRet:={},nCont,nIgual
Local cCbox,cString
Local aSvArea := SX3->(GetArea())

SX3->(DbSetOrder(2))
SX3->(DbSeek(cCampo))

cCbox := SX3->(X3Cbox())
//-- Opcao 1   |Opcao 2 |Opcao 3|Opcao 4
//-- 01=Amarelo;02=Preto;03=Azul;04=Vermelho  
//   | �->nIgual        �->nCont
//   �->cString: 01=Amarelo
//aRet:={{01,Amarelo},{02.Preto},...}

While !Empty(cCbox) 
   nCont:=AT(";",cCbox) 
   nIgual:=AT("=",cCbox)
   cString:=AllTrim(SubStr(cCbox,1,nCont-1)) //Opcao
   IF nCont == 0
       aAdd(aRet,{SubStr(cString,1,nigual-1),SubStr(cString,nigual+1)})
      Exit
   Else
       aAdd(aRet,{SubStr(cString,1,nigual-1),SubStr(cString,nigual+1)})
   Endif 
   cCbox:=SubStr(cCbox,nCont+1)
Enddo
   
RestArea(aSvArea)

Return( aRet )

/*/
�����������������������������������������������������������������������������
�������������������������������������������������������������������������Ŀ��
���Fun��o    �DescTPMarc� Autor � Mauricio MR           � Data � 10.12.01 ���
�������������������������������������������������������������������������Ĵ��
���Descri��o � Retorna Descricao do Tipo da Marcacao                      ���
�������������������������������������������������������������������������Ĵ��
���Parametros� aBox     - Array Contendo as Opcoes do Combox Ja Carregadas���
���          � cTpMarca - Tipo da Marcacao                                ���
�������������������������������������������������������������������������Ĵ��
��� Uso      � Ponr010                                                    ���
��������������������������������������������������������������������������ٱ�
�����������������������������������������������������������������������������
�����������������������������������������������������������������������������/*/
Static Function DescTpMarca(aBox,cTpMarca)

Local aTpMarca:={},cRet:='',nTpMarca:=0
//-- SE Existirem Opcoes Realiza a Busca da Marcacao
If Len(aBox)>0
   nTpmarca:=aScan(aBox,{|xtp| xTp[1] == cTpMarca})
   cRet:=If(nTpMarca>0,aBox[nTpmarca,2],"")
EndIf

Return( cRet )

/*
�����������������������������������������������������������������������������
�����������������������������������������������������������������������������
�������������������������������������������������������������������������Ŀ��
���Fun��o    � Monta_Per� Autor �Equipe Advanced RH     � Data �          ���
�������������������������������������������������������������������������Ĵ��
���Descri��o �                                                            ���
�������������������������������������������������������������������������Ĵ��
���Sintaxe e �                                                            ���
�������������������������������������������������������������������������Ĵ��
���Parametros�                                                            ���
�������������������������������������������������������������������������Ĵ��
���Uso       � Gen�rico                                                   ���
��������������������������������������������������������������������������ٱ�
�����������������������������������������������������������������������������*/
Static Function Monta_Per( dDataIni , dDataFim , cFil , cMat , dIniAtu , dFimAtu )

Local aPeriodos := {}
Local cFilSPO	:= xFilial( "SPO" , cFil )
Local dAdmissa	:= SRA->RA_ADMISSA
Local dPerIni   := Ctod("//")
Local dPerFim   := Ctod("//")

SPO->( dbSetOrder( 1 ) )
SPO->( dbSeek( cFilSPO , .F. ) )
While SPO->( !Eof() .and. PO_FILIAL == cFilSPO )
                       
    dPerIni := SPO->PO_DATAINI
    dPerFim := SPO->PO_DATAFIM  

    //-- Filtra Periodos de Apontamento a Serem considerados em funcao do Periodo Solicitado
    If dPerFim < dDataIni .OR. dPerIni > dDataFim                                                      
		SPO->( dbSkip() )  
		Loop  
    EndIf

    //-- Somente Considera Periodos de Apontamentos com Data Final Superior a Data de Admissao
    If ( dPerFim >= dAdmissa )
       aAdd( aPeriodos , { dPerIni , dPerFim , Max( dPerIni , dDataIni ) , Min( dPerFim , dDataFim ) } )
	Else
		Exit
	EndIf

	SPO->( dbSkip() )

End While

If ( aScan( aPeriodos , { |x| x[1] == dIniAtu .and. x[2] == dFimAtu } ) == 0.00 )
	dPerIni := dIniAtu
	dPerFim	:= dFimAtu 
	If !(dPerFim < dDataIni .OR. dPerIni > dDataFim)
		If ( dPerFim >= dAdmissa )
			aAdd(aPeriodos, { dPerIni, dPerFim, Max(dPerIni,dDataIni), Min(dPerFim,dDataFim) } )
		EndIf
    EndIf
EndIf

Return( aPeriodos )

/*
�����������������������������������������������������������������������������
�����������������������������������������������������������������������������
�������������������������������������������������������������������������Ŀ��
���Fun��o    � CarExtAut� Autor � Mauricio MR           � Data � 24/05/02 ���
�������������������������������������������������������������������������Ĵ��
���Descri��o � Retorna Relacao de Horas Extras por Filial/Turno           ���
�������������������������������������������������������������������������Ĵ��
���Parametros� cCodExtras --> String que Contem ou Contera os Codigos     ���
���          � cTnoCad    --> Turno conforme o Dia                        ���
���          � cAutoriza  --> "*" Horas Autorizadas/Nao Autorizadas       ��� 
���          �                "A" Horas Autorizadas                       ��� 
���          �                "N" Horas Nao Autorizadas                   ���
�������������������������������������������������������������������������Ĵ��
��� Uso      � PONM010                                                    ���
��������������������������������������������������������������������������ٱ�
�����������������������������������������������������������������������������
�����������������������������������������������������������������������������*/
Static Function CarExtAut( cCodExtras , cTnoCad , cAutoriza )

Local aTabExtra		:= {}
Local cFilSP4		:= fFilFunc("SP4")
Local cTno			:= ""
Local lFound		:= .F.
Local lRet			:= .T.
Local nX			:= 0
Local naTabExtra	:= 0    
Local ncTurno	    := 0.00

Static aExtrasTno

If ( PCount() == 0.00 )

	aExtrasTno	:= NIL              

Else

	DEFAULT aExtrasTno	:= {} 
		
	//-- Procura Tabela (Filial + Turno corrente)
	If ( lFound	:= ( SP4->( dbSeek( cFilSP4 + cTnoCad , .F. ) ) ) )
	   cTno		:=	cTnoCad
	   lFound	:=	.T.
	Else      
	    //-- Procura Tabela (Filial)    
	    cTno	:= Space(Len(SP4->P4_TURNO))
		lFound	:= SP4->( dbSeek(  cFilSP4 + cTno , .F.) )
	EndIf    
	
	//-- Se Existe Tabela de HE
	If ( lFound )
	   //-- Verifica se a Tabela de HE para o Turno ainda nao foi carregada
	   If (ncTurno:=aScan(aExtrasTno,{|aTurno| aTurno[1]  == cFilSP4 .and. aTurno[2] == cTno} )) == 0.00
	      //-- Se nao Encontrou Carrega Tabela para Filial e Turno especificos
	      GetTabExtra( @aTabExtra , cFilSP4 , cTno , .F. , .F. )     
	      //-- Posiciona no inicio da Tabela de HE da Filial Solicitada
		  If !Empty(aTabExtra)
			  naTabExtra:=	Len(aTabExtra)
			  //-- Corre C�digos de Hora Extra da Filial
			  For nX:=1 To naTabExtra
					//-- Se Ambos os Tipos de Eventos ou Autorizados
					If cAutoriza == '*' .or. (cAutoriza == 'A' .and. !Empty(aTabExtra[nX,4]))
						cCodExtras += aTabExtra[nX,4]+'A' //-- Cod Autorizado                
					EndIf
					//-- Se Ambos os Tipos de Eventos ou Nao Autorizados					
					If cAutoriza == '*' .or. (cAutoriza == 'N' .and. !Empty(aTabExtra[nX,5]))
						cCodExtras += aTabExtra[nX,5]+'N' //-- Cod Nao Autorizado                
					EndIf
			  Next nX
		  EndIf	  
		  //-- Cria Nova Relacao de Codigos Extras para o Turno Lido
		  aAdd(aExtrasTno,{cFilSP4,cTno,cCodExtras})
	    Else
	        //-- Recupera Tabela Anteriormente Lida
	        cCodExtras:=aExtrasTno[ncTurno,3] 
	    EndIf                    
	    
	EndIf	

EndIf

Return( lRet )

/*
�����������������������������������������������������������������������������
�����������������������������������������������������������������������������
�������������������������������������������������������������������������Ŀ��
���Fun��o    � CarId    � Autor � Mauricio MR           � Data � 24/05/02 ���
�������������������������������������������������������������������������Ĵ��
���Descri��o � Retorna Relacao de Eventos da Filial						  ���
�������������������������������������������������������������������������Ĵ��
���Parametros� cFil       --> Codigo da Filial desejada					  ���
���          � aId    	  --> Array com a Relacao	                      ���
���          � cAutoriza  --> "*" Horas Autorizadas/Nao Autorizadas       ��� 
���          �                "A" Horas Autorizadas                       ��� 
���          �                "N" Horas Nao Autorizadas                   ���
�������������������������������������������������������������������������Ĵ��
��� Uso      � PONM010                                                    ���
��������������������������������������������������������������������������ٱ�
�����������������������������������������������������������������������������
�����������������������������������������������������������������������������*/	
Static Function CarId( cFil , aId , cAutoriza )

Local nPos	:= 0.00

//-- Preenche o Array aCodAut com os Eventos (Menos DSR Mes Ant.)
SP9->( dbSeek( cFil , .T. ) )
While SP9->( !Eof() .and. cFil == P9_FILIAL )
	If ( ( Right(SP9->P9_IDPON,1) == cAutoriza ) .or. ( cAutoriza == "*" ) )
		aAdd( aId , Array( 04 ) )
		nPos := Len( aId )
		aId[ nPos , 01 ] := SP9->P9_CODIGO	//-- Codigo do Evento 
		aId[ nPos , 02 ] := SP9->P9_IDPON 	//-- Identificador do Ponto 
		aId[ nPos , 03 ] := SP9->P9_CODFOL	//-- Codigo do da Verba Folha
		aId[ nPos , 04 ] := SP9->P9_BHORAS	//-- Evento para B.Horas
	EndIf
	SP9->( dbSkip() )
EndDo

Return( NIL )

/*/
�����������������������������������������������������������������������������
�������������������������������������������������������������������������Ŀ��
���Fun��o    �fGetApo   � Autor � Leandro Dr.           � Data � 23.03.15 ���
�������������������������������������������������������������������������Ĵ��
���Descri��o � Retorna Apontamentos do funcionario.                       ���
�������������������������������������������������������������������������Ĵ��
��� Uso      � Ponr010                                                    ���
��������������������������������������������������������������������������ٱ�
�����������������������������������������������������������������������������
�����������������������������������������������������������������������������/*/
Static Function fGetApo(aResult,dInicio,dFim,lImpAcum)
Local aArea		:= GetArea()
Local cAliasQry	:= GetNextAlias()
Local cWhere	:= ""
Local cAliasAux := If(lImpAcum,"SPH","SPC")
Local cPrefixo	:= If(lImpAcum,"PH_","PC_")
Local cJoinFil	:= ""

cWhere += "%"
cWhere += cPrefixo + "FILIAL = '" + SRA->RA_FILIAL + "' AND "
cWhere += cPrefixo + "MAT = '" + SRA->RA_MAT + "' AND "
cWhere += cPrefixo + "DATA >= '" + DtoS(dInicio) + "' AND "
cWhere += cPrefixo + "DATA <= '" + DtoS(dFim) + "' "
cWhere += "%"

If lImpAcum
	cJoinFil:= "%" + FWJoinFilial("SPH", "SP9") + "%"

	BeginSql Alias cAliasQry
	
	 	SELECT             
			SPH.PH_DATA, SPH.PH_PD, SPH.PH_QUANTC, SPH.PH_QUANTI, SP9.P9_CLASEV, SP9.P9_IDPON, SP9.P9_CODIGO
		FROM 
			%Table:SPH% SPH
		INNER JOIN %Table:SP9% SP9
		ON %exp:cJoinFil% AND SP9.%NotDel% AND SPH.PH_PD = SP9.P9_CODIGO		
		WHERE
			%Exp:cWhere% AND SPH.%NotDel%
		ORDER BY SPH.PH_DATA, SPH.PH_PD	
	
	EndSql 	
Else
	cJoinFil:= "%" + FWJoinFilial("SPC", "SP9") + "%"
	
	BeginSql Alias cAliasQry
	
	 	SELECT             
			SPC.PC_DATA, SPC.PC_PD, SPC.PC_QUANTC, SPC.PC_QUANTI, SP9.P9_CLASEV, SP9.P9_IDPON, SP9.P9_CODIGO
		FROM 
			%Table:SPC% SPC
		INNER JOIN %Table:SP9% SP9
		ON %exp:cJoinFil% AND SP9.%NotDel% AND SPC.PC_PD = SP9.P9_CODIGO			
		WHERE
			%Exp:cWhere%  AND SPC.%NotDel%
		ORDER BY SPC.PC_DATA, SPC.PC_PD	
	EndSql 	
EndIf

While !(cAliasQry)->(Eof())
	If (cAliasQry)->P9_CLASEV == "01" //Hora Extra
		If (cAliasQry)->P9_CODIGO $ "064*065*070*071*072*073*074*075*076*077*078*079*080*081*082*083*084*085" //Banco de Horas Credito
			//(cAliasQry)->(aAdd(aResult,{&(cPrefixo+"DATA"),"4",If(&(cPrefixo+"QUANTI")>0,&(cPrefixo+"QUANTI"),&(cPrefixo+"QUANTC"))}))
		ElseIf (cAliasQry)->P9_CODIGO $ "066" //Banco de Horas D�bito
			//(cAliasQry)->(aAdd(aResult,{&(cPrefixo+"DATA"),"5",If(&(cPrefixo+"QUANTI")>0,&(cPrefixo+"QUANTI"),&(cPrefixo+"QUANTC"))}))
		Else
			(cAliasQry)->(aAdd(aResult,{&(cPrefixo+"DATA"),"1",If(&(cPrefixo+"QUANTI")>0,&(cPrefixo+"QUANTI"),&(cPrefixo+"QUANTC"))}))
		EndIf
	ElseIf (cAliasQry)->P9_CLASEV $ "02*03*04*05" //Faltas/Atrasos/Saida antecipada
		(cAliasQry)->(aAdd(aResult,{&(cPrefixo+"DATA"),"2",If(&(cPrefixo+"QUANTI")>0,&(cPrefixo+"QUANTI"),&(cPrefixo+"QUANTC"))}))
	ElseIf (cAliasQry)->P9_IDPON $ "003N*004A*027N*028A" //Adicional Noturno
		(cAliasQry)->(aAdd(aResult,{&(cPrefixo+"DATA"),"3",If(&(cPrefixo+"QUANTI")>0,&(cPrefixo+"QUANTI"),&(cPrefixo+"QUANTC"))}))
	EndIf	
	(cAliasQry)->(DbSkip())
EndDo

(cAliasQry)->(DbCloseArea())

cWhere := "%"
cWhere += "PI_FILIAL = '" + SRA->RA_FILIAL + "' AND "
cWhere += "PI_MAT =    '" + SRA->RA_MAT + "' AND "
cWhere += "PI_DATA >=  '" + DtoS(dInicio) + "' AND "
cWhere += "PI_DATA <=  '" + DtoS(dFim) + "' "
cWhere += "%"

cJoinFil:= "%" + FWJoinFilial("SPI", "SP9") + "%"
cAliasQry := GetNextAlias()

BeginSql Alias cAliasQry

 	SELECT             
		SPI.PI_DATA, SPI.PI_PD, SPI.PI_QUANT, SPI.PI_QUANTV, SP9.P9_CODIGO
	FROM 
		%Table:SPI% SPI
	INNER JOIN %Table:SP9% SP9
	ON SP9.P9_FILIAL = '  ' AND SP9.%NotDel% AND SPI.PI_PD = SP9.P9_CODIGO		
	WHERE
		%Exp:cWhere% AND SPI.%NotDel%
	ORDER BY SPI.PI_DATA, SPI.PI_PD	

EndSql 	

While !(cAliasQry)->(Eof())
	If (cAliasQry)->P9_CODIGO $ "004*015*016*017*019*020*051*053*059*055*057*061*063*065*067*069*071*073" //Banco de Horas Credito
		(cAliasQry)->(aAdd(aResult,{PI_DATA,"4",IIF(PI_QUANTV==0,PI_QUANT,PI_QUANTV)}))
	ElseIf (cAliasQry)->P9_CODIGO $ "601*602*604*606*608*611*904" //Banco de Horas D�bito
		(cAliasQry)->(aAdd(aResult,{PI_DATA,"5",IIF(PI_QUANTV==0,PI_QUANT,PI_QUANTV)}))
	EndIf
	(cAliasQry)->(DbSkip())
EndDo

(cAliasQry)->(DbCloseArea())

RestArea(aArea)

Return Nil

/*/
�����������������������������������������������������������������������������
�������������������������������������������������������������������������Ŀ��
���Fun��o    �fImpSign  � Autor � Leandro Dr.           � Data � 23.03.15 ���
�������������������������������������������������������������������������Ĵ��
���Descri��o � Imprime espa�o para assinatura do funcionario.             ���
�������������������������������������������������������������������������Ĵ��
��� Uso      � Ponr010                                                    ���
��������������������������������������������������������������������������ٱ�
�����������������������������������������������������������������������������
�����������������������������������������������������������������������������/*/
Static Function fImpSign(oPrinter)
	
//Mensagem antes da assinatura
//If !Empty(cMenPad1) .or. !Empty(cMenPad2)
	oPrinter:SayAlign(nLinTot-60,nCol+2,"Reconhe�o a exatid�o das horas constantes de acordo com minha frequ�ncia neste per�odo. Nos termos da Portaria Mtb N� 3626 de 13/11/1991, artigo 13, ",oFont06,700,100,,ALIGN_H_LEFT)
	oPrinter:SayAlign(nLinTot-52,nCol+2,"o presente Cart�o Ponto substitui o quadro de hor�rio de Trabalho, Inclusive o de menores e Ficha de Hor�rio de Trabalho Externo.",oFont06,500,100,,ALIGN_H_LEFT)
//EndIf

oPrinter:SayAlign(nLinTot-20,nCol,Replicate("_",50),oFontP,nColTot,100,,ALIGN_H_CENTER)

oPrinter:SayAlign(nLinTot-10,nCol,STR0013,oFontP,nColTot,100,,ALIGN_H_CENTER) // 'Assinatura do Funcionario'

Return Nil


/*


ͻ
Programa  SLDBH     Autor Rui Ronaldo Scandiuzzi Data  08/05/2015  
͹
Desc.     Funo para retornar o saldo do banco de horas              
                                                                      
͹
Uso        AP                                                         
ͼ


*/

USER FUNCTION SLDBH(CCODFIL,CCODMAT,DDTINI)

LOCAL AAREA     := GETAREA()
LOCAL NSALDOANT := 0

SPI->(DBSETORDER(2))
SPI->(DBSEEK(CCODFIL+CCODMAT))
WHILE !SPI->(EOF()) .AND. SPI->PI_FILIAL+SPI->PI_MAT == CCODFIL+CCODMAT .AND. SPI->PI_DATA < DDTINI
	IF SPI->PI_STATUS == " "
		IF POSSP9( SPI->PI_PD , CCODFIL, "P9_TIPOCOD") $ "1*3"
			NSALDOANT:=SOMAHORAS(NSALDOANT,IIF(SPI->PI_QUANTV==0,SPI->PI_QUANT,SPI->PI_QUANTV))
		ELSE
			NSALDOANT:=SUBHORAS(NSALDOANT,IIF(SPI->PI_QUANTV==0,SPI->PI_QUANT,SPI->PI_QUANTV))
		ENDIF
	ENDIF
	SPI->( DBSKIP() )
ENDDO

RESTAREA(AAREA)

RETURN(NSALDOANT)
